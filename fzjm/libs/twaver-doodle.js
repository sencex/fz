!function(a,b){var c={};a.doodle=c;var d={};d.edit={},d.edit.interaction={},d.edit.ui={},d.edit.data={},c._version="1.5.1",c.getVersion=function(){return c._version},c._debug=!1,c.isDebug=function(){return c._debug},c.id=function(a){return c.isDebug()?c.debugId(a):(a=a||"",a+mono.id())},c.idIndex=1e4,c.ID_PREFIX="doodle",c.debugId=function(a){return(a?a:c.ID_PREFIX)+"-"+c.idIndex++};var e=function(){};e.prototype.isNotNull=function(a){return a!==b&&"undefined"!==a&&null!==a&&"null"!==a&&""!==a},e.prototype.loadFile=function(a,c){if(a){var d=new XMLHttpRequest;c!==b&&d.addEventListener("load",function(a){c(a.target.responseText)},!1),d.open("GET",a,!0),d.send(null)}},e.prototype.isCtrlDown=function(a){return a.ctrlKey||a.metaKey},e.prototype.isAltDown=function(a){return a.altKey},e.prototype.isShiftDown=function(a){return a.shiftKey},e.prototype.load2dSceneCategory=function(){var a=new c.AccordionData;return a.filterCategory=function(a){return"2d房间模型"==a||"2d机柜模型"==a||"2d环境模型"==a?!0:!1},a.sortCategories=function(a){return a},a.filterModel=function(a){return"twaver.idc.floor.top"==a||"twaver.idc.column.top"==a?!1:!0},a.getData()},e.prototype.load2dRackCategory=function(a){var b=new c.AccordionData;return b.filterCategory=function(b){return"基本模型"==b?!1:""==b?!1:a||"设备2D"==b||"设备模板"==b?"机柜"!=b&&"设备2D"!=b&&"设备模板"!=b&&"机柜模板"!=b?!1:!0:!1},b.getData()},e.prototype.load2dDeviceCategory=function(){var a=new c.AccordionData;return a.filterCategory=function(a){return"基本模型"==a?!1:""==a?!1:["设备面板","面板部件","面板背板"].indexOf(a)<0?!1:!0},a.getData()},e.prototype.load2dCircuitCategory=function(){var a=new c.AccordionData;return a.filterCategory=function(a){return"基本模型"==a?!1:""==a?!1:"基本"==a?!0:["组件"].indexOf(a)<0?!1:!0},a.getData()},e.prototype.load3dModelCategory=function(){var a=new c.AccordionData;return a.filterCategory=function(a){return"基本模型"==a||"机柜模型"==a||"设备模型"==a||"板卡"==a?!0:!1},a.getData()},e.prototype.transformAndScaleCanvasContext=function(b,c){var d=b.getContext("2d");if(!c&&b.isTransfor&&b.width&&b.height)return d;var e=a.devicePixelRatio||1,f=d.webkitBackingStorePixelRatio||d.mozBackingStorePixelRatio||d.msBackingStorePixelRatio||d.oBackingStorePixelRatio||d.backingStorePixelRatio||1,g=e/f;if(e!==f){var h=b.width,i=b.height;b.width=h*g,b.height=i*g,b.style.width=h+"px",b.style.height=i+"px",d.scale(g,g)}return b.width&&b.height&&(b.isTransfor=!0),d},e.prototype.animateCamera=function(a,b,c,d,e){var f=a.getPosition().sub(a.getTarget()),g=new twaver.Animate({from:0,to:1,dur:500,easing:"easeBoth",onUpdate:function(e){var g=c.x+(d.x-c.x)*e,h=c.y+(d.y-c.y)*e,i=c.z+(d.z-c.z)*e,j=new mono.Vec3(g,h,i);a.lookAt(j),b.target=j;var k=(new mono.Vec3).addVectors(f,j);a.setPosition(k)}});g.onDone=e,g.play()},e.prototype.findFirstObjectByMouse=function(a,c,d){d===b&&(d=this.findFirstObjectByMouseFilter);var e=a.getElementsByMouseEvent(c);if(e.length){if(!d)return e[0];for(var f=0;f<e.length;f++){var g=e[f],h=g.element;if(d(h))return g}}return null},e.prototype.findFirstObjectByMouseFilter=function(a){return!(a instanceof mono.Billboard)},e.prototype.getUrlParam=function(b){var c=new RegExp("(^|&)"+b+"=([^&]*)(&|$)"),d=a.location.search.substr(1).match(c);return null!=d?unescape(d[2]):null},e.prototype.getModelParameter=function(a){return make.Default.getModelDefaultParameters(a)},e.prototype.initPropertySheet=function(a){a.setEditable(!0);a.getPropertyBox()},e.prototype.addProperties=function(a,b){b.forEach(function(b){a.add(b)})},e.prototype.createSceneNetwork3D=function(a){var b=this;a=a||{};var c=a.network||new mono.Network3D,d=c.getDataBox();if(!a.initialized){var e=new mono.PerspectiveCamera(30,1.5,50,2e4);c.setCamera(e),e.p(1328.647469988342,2925.856952899234,2084.0725294541244),e.look(new mono.Vec3(1356.0876637604608,255.78986100252212,-567.4369627978233));var f=c.getDefaultInteraction();f.yLowerLimitAngle=Math.PI/180*2,f.yUpLimitAngle=Math.PI/2,f.maxDistance=1e4,f.minDistance=50,f.zoomSpeed=3,f.panSpeed=.2,c.setInteractions([f]);var g=new mono.PointLight(16777215,.1);g.setPosition(8e3,8e3,8e3),d.add(g),d.add(new mono.AmbientLight("white"))}var h=c.getRootView(),i=null;a.renderView&&"string"!=typeof a.renderView&&(i=a.renderView),i||(i=document.getElementById(a.renderView)),i||(i=document.getElementsByClassName(a.renderView)[0]),i||(i=document.createElement("div"),i.setAttribute("class","renderView-scene-3d"),i.style.position="absolute",i.style.width="100%",i.style.height="100%",document.body.appendChild(i)),i.appendChild(h),mono.Utils.autoAdjustNetworkBounds(c,i,"clientWidth","clientHeight",0,0);var j=h.getAttribute("class");return j||(j=""),h.setAttribute("class",j+"  network3d-view"),h.addEventListener("dblclick",function(d){b.handleDoubleClick(d,c,a.handleDoubleClick)}),c},e.prototype.loadSceneData=function(a,b,c){var d=make.Default.load(b,null,{});for(var e in d){var b=d[e];c&&c(b)||a.addByDescendant(b)}},e.prototype.loadDeviceData=function(a,b,c,d){var e=b,f=make.Default.RACK_OFFSET_Y,g=make.Default.getUnitHeight(),h=e.getBoundingBox(),i=make.Default.load(c);for(var j in i){var k=i[j];if(!d||!d(k)){var l=c[j].client.loc,m=k.getBoundingBox(),n=f+l*g-(h.max.y-h.min.y)/2+g;k.setY(n),k.setZ((h.max.z-h.min.z)/2-(m.max.z-m.min.z)/2+1),k.setParent(e),a.addByDescendant(k)}}},e.prototype.handleDoubleClick=function(a,b,c){var d=b.getCamera(),e=b.getDefaultInteraction(),f=this.findFirstObjectByMouse(b,a);if(f){var g=f.element,h=f.point,i=d.getTarget();if(this.animateCamera(d,e,i,h,function(){g.getClient("animation")&&make.Default.playAnimation(g,g.getClient("animation"))}),g.getClient("dbl.func")){var j=g.getClient("dbl.func");j(g,b,f,a)}else if("rack_door"==g.getClient("type")){var j=g.getParent().getClient("dbl.func");j&&j(g.getParent(),b,f,a)}c&&c(g,b,f,a)}else{var i=d.getTarget(),h=new mono.Vec3(0,0,0);this.animateCamera(d,e,i,h)}},e.prototype.createPanelDialog=function(){if(a.$&&a.$.ui&&a.$.ui.dialog){var b=$("<div class='panel-main'></div>").appendTo(document.body);return $(b).dialog({title:"设备面板",width:1e3,height:500,modal:!0,close:function(){b.network.dispose(),b.remove()}}),b}throw"there is not import jquery and jquery-ui.js"},e.prototype.createPanelNetwork2D=function(a){a=a||{};var b=a.network||new twaver.vector.Network,c=(b.getElementBox(),b.getView());b.setMaxZoom(50),c.setAttribute("class","network-view-device-panel");var d=null;a.renderView&&"string"!=typeof a.renderView&&(d=a.renderView),d||(d=document.getElementById(a.renderView)),d||(d=document.getElementsByClassName(a.renderView)[0]),d||(d=document.createElement("div"),d.setAttribute("class","renderView-panel"),d.style.position="absolute",d.style.width="100%",d.style.height="100%",document.body.appendChild(d)),d.appendChild(c);var e=d.clientWidth,f=d.clientHeight;return b.adjustBounds({x:0,y:0,width:e,height:f}),setTimeout(function(){b.zoomOverview()},500),b},e.prototype.loadPanelData=function(a,b,c,d,e){e=e||1,c=c||0,d=d||0;var f=make.Default.load({id:"twaver.idc.panel.loader",data:b,scale:e,x:c,y:d});f instanceof Array?f.forEach(function(b){a.addByDescendant(b)}):a.addByDescendant(f)},e.prototype.getSceneEditorModel3dId=function(a){var b=a.replace(i.MODEL_SUFFIX_SEPARATOR+i.SCENE_MODEL_SUFFIX,""),c=b+i.MODEL_SUFFIX_SEPARATOR+i.SCENE_MODEL_SUFFIX;return i.sceneEditorModel2dTo3dMapping[c]||b},e.prototype.getSceneEditorModel2dId=function(a){var b=a.replace(i.MODEL_SUFFIX_SEPARATOR+i.SCENE_MODEL_SUFFIX,""),c=b+i.MODEL_SUFFIX_SEPARATOR+i.SCENE_MODEL_SUFFIX;return i.sceneEditorModel3dTo2dMapping[b]||c},e.prototype.getRackEditorModel3dId=function(a){var b=a.replace(i.MODEL_SUFFIX_SEPARATOR+i.RACK_MODEL_SUFFIX,""),c=b+i.MODEL_SUFFIX_SEPARATOR+i.RACK_MODEL_SUFFIX;return i.rackEditorModel2dTo3dMapping[c]||b},e.prototype.getRackEditorModel2dId=function(a){var b=a.replace(i.MODEL_SUFFIX_SEPARATOR+i.RACK_MODEL_SUFFIX,""),c=b+i.MODEL_SUFFIX_SEPARATOR+i.RACK_MODEL_SUFFIX;return i.rackEditorModel3dTo2dMapping[b]||c},e.prototype.getDeviceEditorModel3dId=function(a){var b=a.replace(i.MODEL_SUFFIX_SEPARATOR+i.DEVICE_MODEL_SUFFIX,""),c=b+i.MODEL_SUFFIX_SEPARATOR+i.DEVICE_MODEL_SUFFIX;return i.deviceEditorModel2dTo3dMapping[c]||b},e.prototype.getDeviceEditorModel2dId=function(a){var b=a.replace(i.MODEL_SUFFIX_SEPARATOR+i.DEVICE_MODEL_SUFFIX,""),c=b+i.MODEL_SUFFIX_SEPARATOR+i.DEVICE_MODEL_SUFFIX;return i.deviceEditorModel3dTo2dMapping[b]||c},e.prototype.createImportDialog=function(a,b,c){this.fileIndex=this.fileIndex||1;var e="files-"+this.fileIndex;this.fileIndex++;var f=new d.edit.Dialog(a,{OK:function(){var a=$("#"+e)[0];if(a.files&&a.files.length>0){var d=a.files[0];if(d.name.indexOf(".")>0){var f=d.name.split(".");if(f[1]!=b)return void alert("file format should be "+b);var g=new FileReader;g.readAsText(d),g.onloadend=function(){g.error?console.log(g.error):c&&c(g.result)}}}$(this).dialog("close")},Cancel:function(){$(this).dialog("close")}});f.init(),f.getView().dialog("option","width",450),f.getView().dialog("option","height",180);var g="<div   ><label class='field'>File Path:</label>   <input id='"+e+"' type='file' class='input' size='20'/></div>";return f.setData(g),f},e.prototype.createExportDialog=function(a){a instanceof Object&&(a=JSON.stringify(a));var b="<div>导出数据：<br><textarea>"+a+"</textarea></div>";$(b).dialog({title:"导出json",width:400,height:500})},e.prototype.createJsonObject=function(a,b,c){if(b.length>0)for(var d=0;d<b.length;d++){var e=b[d];c&&(e.dataType=c);var g=f._getJsonData(e);a.add(g)}},e.prototype._getJsonData=function(a){var b=new d.edit.data.JsonObject,c=a.id,e=a.data,g=a.position||[0,0,0],h=a.width,i=a.depth;if(c&&(b.id=c),null!=e&&e.length>0){var j=[];if(e[0]instanceof Array)for(var k=0;k<e.length;k++){var l=e[k],m=e[k].length;2==m?j.push([l[0]-g[0],l[1]-g[2]]):5==m&&j.push([l[0],l[1]-g[0],l[2]-g[2],l[3]-g[0],l[4]-g[2]])}else for(var k=0;k<e.length;k+=2)j.push([e[k]-g[0],e[k+1]-g[2]]);b.setData(j)}if(a.children){for(var n=[],k=0;k<a.children.length;k++){var o=a.children[k],p=f._getJsonData(o);n.push(p)}b.setChildren(n)}return g&&b.setPosition(g),h&&b.setWidth(h),i&&b.setDepth(i),a.rotation&&b.setRotation(a.rotation),a.closed&&b.setClosed(a.closed),a.showFloor&&b.setShowFloor(a.showFloor),b.client={label:make.Default.getName(c)},a.dataType&&(b.client.dataType=a.dataType),a.client&&b.setClient(a.client),b},e.prototype.isEditModel=function(a){var b=a.getClient("type"),c=["door","window"];return b&&c.indexOf(b)>=0?!1:!0},e.prototype.isMoveModel=function(a){var b=a.getClient("type"),c=["door","window"];return b&&c.indexOf(b)>=0?!1:!0},e.prototype.stopPropagation=function(a){a.stopPropagation&&a.stopPropagation(),a.preventDefault?a.preventDefault():a.returnValue=!1},e.prototype.parseDxf=function(a){var b=new d.edit.ImportDxf,c=b.loadDxf(a);return c},e.prototype.o2s=function(a){try{return JSON.stringify(a)}catch(b){throw b}},e.prototype.s2o=function(a){try{return JSON.parse(a)}catch(b){throw b}},e.prototype.clone=function(a){return a.clone?a.clone():f.s2o(f.o2s(a))},e.prototype.ext=function(a,b,c){var d=a.prototype;if(twaver.Util.ext(a,b,c),d&&a.prototype)for(var e in d)a.prototype[e]=d[e]},e.prototype.addMask=function(a){var b;parseInt(document.body.scrollWidth),parseInt(document.body.scrollHeight);return b=document.createElement("div"),a?b.setAttribute("id","mask_"+a):b.setAttribute("id","mask"),b.setAttribute("class","mask"),document.body.appendChild(b),b},e.prototype.setDialogRect=function(a){var b=document.getElementById("mask");if(document.getElementById("mask_"+a)&&(b=document.getElementById("mask_"+a)),b){var c=b.offsetWidth,d=b.offsetHeight,e=document.getElementById(a),f=e.offsetWidth,g=e.offsetHeight;e.style.left=c/2-f/2+"px",e.style.top=d/2-g/2+"px"}},e.prototype.queryString=function(a,b){var c=new RegExp(""+b+"=([^&?]*)","ig");return a.match(c)?a.match(c)[0].substr(b.length+1):null},e.prototype.isPointInRect=function(a,b){return a.x>b.x&&a.x<b.x+b.width&&a.y>b.y&&a.y<b.y+b.height},e.prototype.moveSelectionElements=function(a,b,c,d){var e=a.getSelectionModel().getSelection();if(e.size()>0){var f=0,g=0;"left"===b&&(f=-c),"right"===b&&(f=c),"top"===b&&(g=-d),"bottom"===b&&(g=d),twaver.Util.moveElements(e,f,g,!1)}};var f=new e;c.Utils=c.utils=f;var g=function(){this._data=[],this.init()};g.prototype={init:function(){this._data=[];var a=this,b=make.Default.getCategories(),c=[];b.forEach(function(b){a.filterCategory&&a.filterCategory(b)===!1||c.push(b)}),this.sortCategories&&(c=this.sortCategories(c)),c.forEach(function(b){var c=[],d=make.Default.getCreatorsForCategory(b);for(var e in d)if(!a.filterModel||a.filterModel(e)!==!1){var f=make.Default.getParameters(e),g=make.Default.getIcon(e),h=make.Default.isCombo(e);c.push({id:e,icon:g,label:f.name,category:b,combo:h})}a.sortModels&&(c=a.sortModels(c)),c&&c.length>0&&a._data.push({title:b,contents:c})})},getData:function(){return this.init(),this._data},filterCategory:function(a){return"基本模型"==a?!1:""==a?!1:!0},sortCategories:function(a){return a},filterModel:function(a){return!0},sortModels:function(a){return a}},c.AccordionData=g,c.utils.ext(g,Object);var h=function(){this.init(),this._categories=[],this._visible=!0,this._reset=!0};h.prototype={init:function(){this.paneBox=$('<div id="accordion-resizer" class="ui-widget-content"></div>'),this.mainPane=$('<div id="accordion"></div>').appendTo(this.paneBox),this.mainPane.accordion({heightStyle:"fill"})},setCategories:function(a){var b=this._categories;this._categories=a,this.mainPane.accordion("destroy"),this.mainPane.empty();var c=this;if(a)for(var d=0;d<a.length;d++){var e=a[d],f=$("."+e.title);0==f.length&&(f=$('<h3 class="'+e.title+'">'+e.title+"</h3>").appendTo(this.mainPane),$('<ul class="mn-accordion"></ul>').appendTo(this.mainPane));var g=f.next(".mn-accordion");e.contents.forEach(function(a){var b=a.icon;(!b||b.indexOf("undefined")>=0)&&(b="images/cloud-up-icon.png");var d=$('<li class="item-li"></li>').appendTo(g),e=$("<img src="+b+" title="+(a.description||a.label)+"></img>"),f=$('<div class="item-label">'+a.label+"</div>");d.append(e),d.append(f),c.setImageDraggable(e[0],a)})}return this.mainPane.accordion({heightStyle:"fill"}),this.mainPane.accordion("refresh"),this.refresh(),b},getCategories:function(){return this._categories},setVisible:function(a){this._visible!=a&&(this._visible=a,this._visible?this.paneBox.show():this.paneBox.hide())},isVisible:function(){return this._visible},refresh:function(){var a=this;setTimeout(function(){a.mainPane.accordion("refresh")},100)},getView:function(){return this.paneBox[0]},setImageDraggable:function(a,b){var c=this;d.edit.DragAndDrop.setDragTarget(a,b,{effectAllowed:"copyMove",dragImage:b.dragImage||b.icon,ondrag:function(a){c.ondrag&&c.ondrag(a,b)}})},ondrag:function(a,b){}},c.AccordionPane=d.edit.AccordionPane=h,c.utils.ext(h,Object);var i={MODEL_SUFFIX_SEPARATOR:".",SCENE_MODEL_SUFFIX:"top",RACK_MODEL_SUFFIX:"front",DEVICE_MODEL_SUFFIX:"panel",REDIRECT_RACK_EDITOR:!0,REDIRECT_DEVICE_EDITOR:!0,sceneEditorModel3dTo2dMapping:{},sceneEditorModel2dTo3dMapping:{},rackEditorModel3dTo2dMapping:{},rackEditorModel2dTo3dMapping:{},deviceEditorModel3dTo2dMapping:{},deviceEditorModel2dTo3dMapping:{},circuitEditorModel3dTo2dMapping:{},circuitEditorModel2dTo3dMapping:{},pasteOffsetX:10,pasteOffsetY:10,pasteOffsetZ:10};c.consts=i,d.edit.Consts=i;var j=d.edit.Dialog=function(a,b,c,d){var a=a||"Dialog";this.dialog=$('<div id="export-message" title = "'+a+'"></div>'),this.content=$('<div class="inner" ></div>'),this.dialog.append(this.content),this.buttons=b,this.params=c||{}};j.prototype.setData=function(a){"string"==typeof a?this.content.html(a):this.content.append(a)},j.prototype.getView=function(){return this.dialog},j.prototype.init=function(){this.buttons||(this.buttons={Ok:function(){$(this).dialog("close")}}),this.dialog.dialog({height:300,width:350,autoOpen:!1,show:{effect:"fade"},hide:{effect:"fade"},modal:!0,buttons:this.buttons,close:this.params.close})},j.prototype.show=function(){this.dialog.dialog("open")},j.prototype.hide=function(){this.dialog.dialog("close")};var k=d.edit.DragAndDrop={};k.setDragImage=function(a,b){if(a){var c=a;"string"==typeof a&&(a=document.createElement("img"),a.setAttribute("src",c)),b.dataTransfer.setDragImage&&b.dataTransfer.setDragImage(a,a.width/2,a.height/2)}},k.setDragTarget=function(a,b,c){c=c||{},a.setAttribute("dragable",!0);var d=b;null!=b&&"string"!=typeof d&&(d=JSON.stringify(d));var e=c.dragImage;a.ondragstart=function(a){d&&a.dataTransfer.setData("Text",d),c.effectAllowed&&(a.dataTransfer.effectAllowed=c.effectAllowed),k.setDragImage(e,a),c.ondragstart&&c.ondragstart(a)},c.ondragend&&(a.ondragend=c.ondragend),c.ondrag&&(a.ondrag=c.ondrag)},k.allowDrop=function(a){a.preventDefault()},k.setDropTarget=function(a,b){b=b||{},b.ondragenter&&(a.ondragenter=b.ondragenter),a.ondragover=function(a){k.allowDrop(a),b.dropEffect&&(a.dataTransfer.dropEffect=b.dropEffect);var c=a.dataTransfer.getData("Text");b.ondragover&&b.ondragover(a,c)},a.ondragleave=b.ondragleave,a.ondrop=function(a){a.preventDefault();var c=a.dataTransfer.getData("Text");b.ondrop&&b.ondrop(a,c)}};var l=function(a){var b=this;this.parentView=$(a),this._accordionVisible=!0,this._propertySheetVisible=!0,this.accordionPane=null,this.ruler=null,this.network2d=null,this.bidQuickFinder=null,this.undoManager=null,this.copyFilter=function(a){return a},this.pasteFilter=function(a){return a},this.flowAndCopyFilter=function(a){return a},this.parentView.resize(function(){b.parentResizeHandle&&b.parentResizeHandle()}),this.contentPane=$('<div class="editor-container"></div>').appendTo(a),this.propertySheetBox=$('<div class="propertySheetBox right-content"></div>').appendTo(this.contentPane),this.accordionPaneBox=$('<div class="accordionPaneBox"></div>').appendTo(this.contentPane),this.networkBox=$('<div class="networkBox"></div>').appendTo(this.contentPane),this.adjustBounds({left:"0px",right:"0px",top:"0px",bottom:"0px"}),this.flowOffsetX=0,this.flowOffsetY=0,this.pasteOffsetDx=i.pasteOffsetX,this.pasteOffsetDy=i.pasteOffsetY,this.pasteOffsetDz=i.pasteOffsetZ,this.pasteOffsetX=i.pasteOffsetX,this.pasteOffsetY=i.pasteOffsetY,this.pasteOffsetZ=i.pasteOffsetZ,this._copyAnchor=[],this._init()};l.prototype={_init:function(){this.setPropertySheetVisible(!0),this.setAccordionVisible(!0),this.propertySheetBox.hide()},setAccordionVisible:function(a){this._accordionVisible!=a&&(this._accordionVisible=a,a?(this.accordionPaneBox.show(),this.networkBox.css("left",200)):(this.accordionPaneBox.hide(),this.networkBox.css("left",0)),this.invalidate())},invalidate:function(){},addKeyMoveListener:function(a){var b=a.getElementBox();a.getView().addEventListener("keydown",function(c){var d=!1,e=a.getPositionMagneticX(),g=a.getPositionMagneticY();37==c.keyCode&&(f.moveSelectionElements(b,"left",e,g),d=!0),38==c.keyCode&&(f.moveSelectionElements(b,"top",e,g),d=!0),39==c.keyCode&&(f.moveSelectionElements(b,"right",e,g),d=!0),40==c.keyCode&&(f.moveSelectionElements(b,"bottom",e,g),d=!0),d&&(c.preventDefault(),c.stopPropagation())})},isAccordionVisible:function(){return this._accordionVisible},setPropertySheetVisible:function(a){this._propertySheetVisible!=a&&(this._propertySheetVisible=a,a?this.propertySheetBox.show():this.propertySheetBox.hide())},resetPropertySheetBoxSize:function(a){var b=this;clearTimeout(this.resetPropertySheetBoxSizeTimer),this.resetPropertySheetBoxSizeTimer=setTimeout(function(){var c=a.getDataDiv().clientHeight;b.propertySheetBox.height(c+1);var d=b.propertySheetBox.width(),e=b.propertySheetBox.height();a.adjustBounds({x:0,y:0,width:d,height:e})},500)},isPropertySheetVisible:function(){return this._propertySheetVisible},adjustBounds:function(a){for(var b in a)this.contentPane.css(b,a[b])},parentResizeHandle:function(){this.ruler&&this.ruler.invalidate(),this.accordionPane&&this.accordionPane.refresh()},getBounds:function(){if(this.parentNode){var a=this.parentNode.getLocation(),b=this.parentNode.getSize();return{width:b.width,height:b.height,x:a.x,y:a.y}}var c=this.network2d.getUnionBounds();return c},getScaleByRegion:function(a,b){var c=this.getBounds(),d=a/c.width,e=b/c.height,f=Math.min(d,e);return f},toCanvas:function(a){var b=this.getBounds(),c=a.scale||1,d=a.x||b.x,e=a.y||b.y,f=a.width||b.width,g=a.height||b.height,h=this.network2d.toCanvasByRegion({width:f,height:g,x:d,y:e},c);return{width:h._viewRect.width,height:h._viewRect.height,content:h}},getImage:function(a){a=a||2;var b=this.toCanvas({scale:a}),c=b.content,d=mono.Utils.nextPowerOfTwo(b.width),e=mono.Utils.nextPowerOfTwo(b.height),f=document.createElement("canvas");f.width=d,f.height=e;var g=f.getContext("2d");return g.clearRect(0,0,d,e),g.drawImage(c,0,0,d,e),f.toDataURL()},getIcon:function(a,b){a=a||84,b=b||84;var c=this.getScaleByRegion(a,b),d=this.getBounds();d.scale=c;var e=this.toCanvas(d).content,f=e.width,g=e.height,h=(a-f)/2,i=(b-g)/2,j=document.createElement("canvas");j.width=a,j.height=b;var k=j.getContext("2d");return k.clearRect(0,0,a,b),k.drawImage(e,h,i),j.toDataURL()},setShowGrid:function(a){this.network2d.setShowGrid(a)},isShowGrid:function(){return this.network2d.isShowGrid()},setAutoShowOrHideGrid:function(a){this.network2d.autoShowOrHide=a},isAutoShowOrHideGrid:function(){return this.network2d.autoShowOrHide},getPositionMagneticX:function(){return this.network2d.getPositionMagneticX()},setPositionMagneticX:function(a){return this.network2d.setPositionMagneticX(a)},getPositionMagneticY:function(){return this.network2d.getPositionMagneticY()},setPositionMagneticY:function(a){return this.network2d.setPositionMagneticY(a)},isPositionMagneticEnabled:function(){return this.network2d.isPositionMagneticEnabled()},setPositionMagneticEnabled:function(a){return this.network2d.setPositionMagneticEnabled(a)},setGrids:function(a){var b=this.network2d.setGrids(a);return this.network2d.repaint(),b},getGrids:function(){return this.network2d.getGrids()},zoomOverview:function(){console.warn("this method[{}] is not supported".format("zoomOverview"))},getData:function(){return console.warn("this method[{}] is not supported".format("getData")),[]},setData:function(a){console.warn("this method[{}] is not supported".format("setData"))},getSelectedData:function(){return console.warn("this method[{}] is not supported".format("getSelectedData")),[]},appendData:function(a){console.warn("this method[{}] is not supported".format("appendData"))},removeData:function(a){console.warn("this method[{}] is not supported".format("appendData"))},clear:function(){return console.warn("this method[{}] is not supported".format("clear")),[]},copySelection:function(a){a=a||this.copyFilter;var b=this.getSelectedData();return this._clearPasteOffset(),a&&(b=a(b)),this._copyAnchor=b,this._copyAnchor},pasteSelection:function(a,b){b=b||this.pasteFilter;var d=this;if(!this._copyAnchor||0==this._copyAnchor.length)return null;var e=this.network2d.getSelectionModel();a=a||this._getPasteOffset();var g=[];this._copyAnchor.forEach(function(e){var h=f.clone(e);if(h.objectId=c.id(),g.push(h),h.position){var i=h.position;h.position=[i[0]+a.x,i[1],i[2]+a.z]}if(h.location){var j=h.location;j instanceof Array?h.location=[i[0]+a.x,i[1]+a.z]:(h.location.x+=a.x,h.location.y+=a.z)}h.x&&(h.x+=a.x),h.y&&(h.y+=a.z),b&&(h=b(h)),h&&d.appendData(h)}),setTimeout(function(){e.clearSelection(),g.forEach(function(a){var b=d.network2d.getElementBox().getDataById(a.objectId);e.appendSelection(b)})},100)},flowAndCopy:function(a,b,d){d=d||this.flowAndCopyFilter;var e=this,g=this.getSelectedData(d);if(1!=g.length)return"you can use this fun only select one data";g=g[0];var h=[],i=this.network2d.getElementBox().getDataById(g.objectId);if(!i.getSize)return"this fun used node";var j=i.getSize();j=j||{width:60,height:60};for(var k=j.width+this.flowOffsetX,l=j.height+this.flowOffsetY,m=k,n=l,o=0;b>o;o++){var p=f.clone(g);if(p.objectId=c.id(),h.push(p),p.position){var q=p.position;"hor"==a?(q[0]+=m,m+=k):(q[2]+=n,n+=l)}d&&(p=d(p)),p&&this.appendData(p)}setTimeout(function(){var a=e.network2d.getSelectionModel();h.forEach(function(b){var c=e.network2d.getElementBox().getDataById(b.objectId);a.appendSelection(c)})},100)},_getPasteOffset:function(){return this.pasteOffsetX+=this.pasteOffsetDx,this.pasteOffsetY+=this.pasteOffsetDy,this.pasteOffsetZ+=this.pasteOffsetDz,{x:this.pasteOffsetX,y:this.pasteOffsetY,z:this.pasteOffsetZ}},_clearPasteOffset:function(){this.pasteOffsetX=0,this.pasteOffsetY=0,this.pasteOffsetZ=0},findByBID:function(a){return this.bidQuickFinder||(this.bidQuickFinder=new twaver.QuickFinder(this.network2d.getElementBox(),"bid","client")),this.bidQuickFinder.findFirst(a)},setUndoManagerEnabled:function(a){this.undoManager=this.undoManager||this.network2d.getElementBox().getUndoManager(),this.undoManager.setEnabled(a)},undo:function(){this.undoManager=this.undoManager||this.network2d.getElementBox().getUndoManager(),this.undoManager.undo()},redo:function(){this.undoManager=this.undoManager||this.network2d.getElementBox().getUndoManager(),this.undoManager.redo()},startBatch:function(){this.undoManager=this.undoManager||this.network2d.getElementBox().getUndoManager(),this.undoManager.startBatch()},endBatch:function(){this.undoManager=this.undoManager||this.network2d.getElementBox().getUndoManager(),this.undoManager.endBatch()}},c.utils.ext(l,Object),c.Editor=l,d.edit.GridNetwork=function(a){a=a||new twaver.ElementBox,d.edit.GridNetwork.superClass.constructor.call(this,a),this._positionMagneticEnabled=!0,this._positionMagneticX=10,this._positionMagneticY=10,this.grids=[],this._showGrid=!0,this.autoShowOrHide=!0,this.grid1={width:1e3,height:1e3,visible:!0,visibleFilter:function(a){return a>.05},shapeColor:"#FF0000",shapeSize:1,shape:"line"},this.grid2={width:100,height:100,skipX:[],skipY:[],visible:!0,visibleFilter:function(a){return a>.12},shapeColor:"#FFAA00",shapeSize:1,shape:"line"},this.grid3={width:50,height:50,skipX:[100],skipY:[100],visible:!0,visibleFilter:function(a){return a>1},shapeColor:"#FFFFAE",shapeSize:1,shape:"line"},this.grid4={width:10,height:10,skipX:[100,50],skipY:[100,50],visible:!0,visibleFilter:function(a){return a>2},shapeColor:"#AAFF00",shapeSize:2.5,shape:"point"},this.initGridNetwork()},d.edit.GridNetwork.prototype={initGridNetwork:function(){var a=this;this.setKeyboardRemoveEnabled(!1),this._box.addDataBoxChangeListener(function(b){var c=b.kind,d=b.data;"add"==c&&a.nodePositionMagneticInit(d)},this),this.addInteractionListener(function(b){if("liveMoveStart"==b.kind){var c=a._box.getSelectionModel().getSelection();a.beginMove(c)}else if("liveMoveEnd"==b.kind){var c=a._box.getSelectionModel().getSelection();a.endMove(c)}else"doubleClickBackground"==b.kind&&a.autoShowOrHide&&a.setShowGrid(!a.isShowGrid())},this),this.addPropertyChangeListener(function(a){"zoom"==a.property&&this.invalidateGrids(this.grids)},this),this.grids.push(this.grid1),this.grids.push(this.grid2),this.grids.push(this.grid3),this.grids.push(this.grid4),this.invalidateGrids(this.grids)},beginMove:function(a){a&&a.size()>0&&a.forEach(function(a){a instanceof twaver.Node&&(a.childNodeLiveMove=!0,a.childNodeLastPoint=a.getLocation(),a.childNodeLastPointOffset={x:0,y:0})})},endMove:function(a){a&&a.size()>0&&a.forEach(function(a){delete a.childNodeLiveMove,delete a.childNodeLastPoint,delete a.childNodeLastPointOffset})},setGrids:function(a){this.grids=a,this.invalidateGrids(this.grids)},getGrids:function(){return this.grids},resizeCanvas:function(a){this.repaint()},repaint:function(){this.invalidateElementUIs()},setShowGrid:function(a){this._showGrid=a,this.repaint()},isShowGrid:function(){return this._showGrid},setCursorPosition:function(a){this.cursorPosition=a,this.repaint()},getCursorPosition:function(){return this.cursorPosition},invalidateGrids:function(a){for(var b=this.getZoom(),c=a.length,d=0;c>d;d++){var e=a[d];e.skipX=[],e.skipY=[];for(var f=0;d>f;f++)e.skipX.push(a[f].width),e.skipY.push(a[f].height);e.visibleFilter&&(e.visible=e.visibleFilter(b))}},isSkipX:function(a,b){for(var c=0;c<a.skipX.length;c++)if(b%a.skipX[c]==0)return!0;return!1},paintGridAction:function(a,b,c,d){var e=b.width,f=b.height,g=b.bound.x,h=b.bound.y,i=b.bound.w,j=b.bound.h,k=a,l=this.getZoom(),m=g%e,n=h%f,g=g-m-e,h=h-n-f,i=i+2*e,j=j+2*f,o=g,p=g+i,q=h,r=h+j,s={xFrom:o,xEnd:p,yFrom:q,yEnd:r,width:i,height:j},t=b.shapeSize/l;k.lineWidth=t,k.strokeStyle=b.shapeColor;var u=t/2;b.offset=u;for(var v=o;p>v;v+=e)this.isSkipX(b,v)||c.call(this,b,k,s,v);for(var w=q;r>w;w+=f)this.isSkipY(b,w)||d.call(this,b,k,s,w)},isSkipY:function(a,b){for(var c=0;c<a.skipY.length;c++)if(b%a.skipY[c]==0)return!0;return!1},paintPointGrid:function(a,b){this.paintGridAction(a,b,this.paintPointGridX,this.paintPointGridY)},paintPointGridX:function(a,b,c,d){for(var e=c.yFrom;e<c.yEnd;e+=a.height)this.isSkipY(a,e)||(b.moveTo(d-a.offset,e),b.lineTo(d+a.offset,e),b.moveTo(d,e-a.offset),b.lineTo(d,e+a.offset))},paintPointGridY:function(a,b,c,d){},paintLineGrid:function(a,b){this.paintGridAction(a,b,this.paintLineGridX,this.paintLineGridY)},paintLineGridX:function(a,b,c,d){b.moveTo(d-a.offset,c.yFrom),b.lineTo(d-a.offset,c.yEnd)},paintLineGridY:function(a,b,c,d){b.moveTo(c.xFrom,d-a.offset),b.lineTo(c.xEnd,d-a.offset)},paintGrid:function(a,b){this._showGrid&&b.visible&&(a.beginPath(),"point"==b.shape?this.paintPointGrid(a,b):this.paintLineGrid(a,b),a.stroke())},paintGrids:function(a,b){var c=this.grids.length;if(c>0){var d=this.getViewRect(),e=this.getZoom(),f=d.x/e,g=d.y/e,h=d.width/e,i=d.height/e,j=a;j.save();for(var d={x:f,y:g,w:h,h:i},k=0;c>k;k++){var l=this.grids[k];l.bound=d,this.paintGrid(a,l)}j.restore()}},paintBottom:function(a,b){this.paintGrids(a,b)},getPositionMagneticX:function(){return this._positionMagneticX},setPositionMagneticX:function(a){this._positionMagneticX=a},getPositionMagneticY:function(){return this._positionMagneticY},setPositionMagneticY:function(a){this._positionMagneticY=a},isPositionMagneticEnabled:function(){return!!this._positionMagneticEnabled},setPositionMagneticEnabled:function(a){return this._positionMagneticEnabled=a},getNodePositionMagneticX:function(a){if(a){var c=a.getClient("magnetic.x");if(c!=b&&null!=c)return c}return this.getPositionMagneticX()},getNodePositionMagneticY:function(a){if(a){var c=a.getClient("magnetic.y");if(c!=b&&null!=c)return c}return this.getPositionMagneticY()},isNodePositionMagneticDisabled:function(a){if(a){var b=a.getClient("magnetic.disabled");if(b)return!0}return!this.isPositionMagneticEnabled()},setNodePositionMagnetic:function(a,b,c){if(!this.isNodePositionMagneticDisabled(a)&&!this.isEditingElement(a))var d=this.getNodePositionMagneticX(a),e=this.getNodePositionMagneticY(a),b=Math.round(b/d)*d,c=Math.round(c/e)*e;a.originalSetLocation(b,c)},nodePositionMagneticInit:function(a){if(a instanceof twaver.Node&&!a.originalSetLocation){var b=this,c=a.setLocation;a.originalSetLocation=c,a.setLocation=function(c,d){if(1==arguments.length){var e=c;c=e.x,d=e.y}b.setNodePositionMagnetic(a,c,d)};var d=a.translate;a.translate=function(c,e){if(a.childNodeLiveMove){a.childNodeLastPointOffset.x+=c,a.childNodeLastPointOffset.y+=e;var f=a.childNodeLastPoint.x+a.childNodeLastPointOffset.x,g=a.childNodeLastPoint.y+a.childNodeLastPointOffset.y;b.setNodePositionMagnetic(a,f,g)}else d.call(a,c,e)};var e=a.getX(),f=a.getY();a.setLocation(e,f)}}},c.utils.ext(d.edit.GridNetwork,twaver.vector.Network),d.edit.PropertySheetPane=function(a){this.rightContent=$('<div class = "right-content"></div>'),this.box=a||new twaver.DataBox,this.initPropertySheet()},twaver.Util.ext(d.edit.PropertySheetPane,Object,{element:null,jsonObj:null,initPropertySheet:function(){this.sheet=new CPropertySheet(this.box),this.sheet.setEditable(!0),this.sheet.setSelectColor("#dadada");var a=this.sheet.getView();a.style.background="white",a.style.position="absolute",a.style.right=0,a.style.top=0,a.style.left=0,a.style.bottom=0,this.rightContent.append($(a));var b=this;this.params=null;var c=new d.edit.Dialog("选择图片资源",{OK:function(a){if(b.params){var d=b.params.view;if(d._isCommitting)return;d._isCommitting=!0,d.commitEditValue(b.params,$("#image-url")[0]);
}c.hide()},Cancel:function(a){var d=b.params.view;d._isCanceling=!0,d.cancelEditing(),c.hide()}},{close:function(){var a=b.params.view;a._isCanceling=!0,a.cancelEditing(),c.hide()}});$("body").append(c.getView()),c.init(),c.getView().dialog("option","width",500),c.getView().dialog("option","height",400);var e=function(a){return a.indexOf("/")>0?a:make.Default.path+"model/idc/images/"+a};this.sheet.renderEditor=function(a){if(b.params=a,a.view._currentEditor)return a.view._currentEditor;if("image"==a.property.getClient("dataType")){var d=a.property.getClient("dataCategory"),f=a.property.getClient("dataId"),g=((new Date).getTime(),"<label>选择图片资源</label><select id='image-url'>"),h=b.getImageResourcesForEdit(d,f,a.property.getPropertyName());if(!h||!h.length)return a.view._currentEditor;h.forEach(function(b){g+=b===a.value?"<option value="+b+" selected='selected'> "+b+"</option>":"<option value="+b+"> "+b+"</option>"}),g+="</select><br><br><br><image id = 'dialogImage'></image>",c.setData(g),c.show(),$("#dialogImage").attr("src",e(a.value)),$("#image-url").change(function(a){var b=$("#image-url").val();b=e(b),$("#dialogImage").attr("src",b)});var i={view:$("#image-url")[0],onKeyDown:[{keyCode:13,handlerEvent:function(b){var d=a.view;d._isCommitting||(d._isCommitting=!0,d.commitEditValue(a,b.target),c.hide())}},{keyCode:27,handlerEvent:function(b){var d=a.view;d._isCanceling=!0,d.cancelEditing(),c.hide()}}]};return i}return null}},getImageResourcesForEdit:function(a,b,c){var d={"设备":["equipment_front-2U.png","server.png","./idc_images/server001.jpg","./idc_images/server002.jpg","./idc_images/server003.jpg","./idc_images/server004.jpg","./idc_images/server005.jpg"],"板卡":["./idc_images/card1.png","card2.png","./idc_images/card3.png","./idc_images/card4.png","./idc_images/card5.png"],"机柜模型":["alternator-top.jpg","air-condition-side.jpg","battery-top.jpg"]};return d[a]},setElement:function(a){var b=this;if(a){this._setValued=!1;var c=a.id,d=make.Default.getModelDefaultParameterProperties(c),e=this.sheet.getPropertyBox();e.clear(),f.addProperties(e,d),this.jsonObj=make.Default.getModelDefaultParametersValues(c),this._generateNode(a,this.jsonObj),this._setValued=!0}setTimeout(function(){var a=b.sheet.getDataDiv().clientHeight;b.rightContent.height(a+1);var c=b.rightContent.width(),d=b.rightContent.height();b.sheet.adjustBounds({x:0,y:0,width:c,height:d})},500)},_generateNode:function(a,b){this.box.clear();var c=this.node=new twaver.Node({id:a.objectId});c.setClient("id",a.id),this.box.add(c),make.Default.objectWrapper(c,"id",function(){return this.getClient("id")}),make.Default.objectWrapper(c,"objectId",function(){return this.getId()}),delete b.id,delete b.objectId;for(var d in b)make.Default.objectWrapper(c,d),c[d]=a[d]||b[d];this.box.getSelectionModel().setSelection(c)},getData:function(){return make.Default.toJson(this.node)},show:function(a,b){var c=this;this.rightContent.css({marginRight:10,width:220}),c.sheet.invalidate(),setTimeout(function(){var a=c.sheet.getDataDiv().clientHeight;c.rightContent.height(a+1);var b=c.rightContent.width(),d=c.rightContent.height();c.sheet.adjustBounds({x:0,y:0,width:b,height:d})},500),b&&b()},hide:function(){this.rightContent.css({marginRight:-220,width:0})},getView:function(){return this.sheet.getView()}}),CPropertySheet=function(a){CPropertySheet.superClass.constructor.call(this,a)},twaver.Util.ext(CPropertySheet,twaver.controls.PropertySheet,{updateCurrentRowIndex:function(a){var b=this._rowList.size();(0>a||a>=b)&&(a=-1);var c,d=this._currentRowIndex;if(a!==d&&(d>=0&&b>d&&(c=this._rowList.get(d),c.nameRender&&(c.nameRender.style.backgroundColor="")),this._currentRowIndex=a),a>=0&&(c=this._rowList.get(a),c.nameRender&&(c.nameRender.style.backgroundColor=this.getSelectColor(),!this._currentEditor&&c.valueRender&&c.valueRender._editInfo))){var e=c.valueRender._editInfo,f=this.renderEditor&&this.renderEditor(c);f?(this._currentEditor=f.view,null!=e.value&&(this._currentEditor.value=e.value)):e.enumInfo?this._currentEditor=$html.createSelect(e.enumInfo,e.value):(this._currentEditor=document.createElement("input"),null!=e.value&&(this._currentEditor.value=e.value));var g=this;if(this._currentEditor){if(f&&f.onKeyDown){var h=f.onKeyDown;h&&Array.isArray(h)&&g._currentEditor.addEventListener("keydown",function(a){for(var b=0;b<h.length;b++)if(h[b].combKey){var c=null;switch(h[b].combKey){case"ctrlKey":c=a.ctrlKey;break;case"shiftKey":c=a.shiftKey;break;case"altKey":c=a.altKey}a.keyCode===h[b].keyCode&&c&&h[b].handlerEvent&&h[b].handlerEvent(a)}else a.keyCode===h[b].keyCode&&h[b].handlerEvent&&h[b].handlerEvent(a)})}else this._currentEditor.addEventListener("keydown",function(a){var b=a.target._editInfo.view;if(13!==a.keyCode||!a.shiftKey)if(13===a.keyCode){if(b._isCommitting)return;b._isCommitting=!0,b.commitEditValue(a.target._editInfo,a.target)}else 27===a.keyCode&&(b._isCanceling=!0,b.cancelEditing())},!1);if(this._currentEditor.keepDefault=!0,this._currentEditor._rowInfo=c,this._currentEditor._editInfo=e,!this._currentEditor.parentNode){var i=this._currentEditor.style;i.position="absolute",i.margin="0px",i.border="0px",i.padding="0px",i.left=this._indent+this._propertyNameWidth+"px",i.top=c.rowDiv.style.top,i.width=c.valueRender.style.width,i.height=c.valueRender.style.height,this._rootDiv.appendChild(this._currentEditor)}twaver.Util.setFocus(this._currentEditor)}}}}),d.edit.Ruler=function(a){d.edit.Ruler.superClass.constructor.apply(this,arguments),this._view=this.createElement("div"),this._view.style.position="absolute",this._view.style.left="0px",this._view.style.right="0px",this._view.style.top="0px",this._view.style.bottom="0px",this._topRuler=this.createElement("canvas"),this._leftRuler=this.createElement("canvas"),this._initRuler(),this.setComponent(a),this.init(),this.invalidate()},twaver.Util.ext(d.edit.Ruler,twaver.controls.ViewBase,{_defaultGap:10,_rulerWidth:20,_lineColor:"#888",_lineIntervalLineColor:"#ccc",_mousePoint:null,_showGuides:!0,onPropertyChanged:function(a){this.invalidate()},init:function(){this._topRuler.visible&&this._view.appendChild(this._topRuler),this._leftRuler.visible&&this._view.appendChild(this._leftRuler),this.component.getView?this._view.appendChild(this.component.getView()):this._view.appendChild(this.component)},setComponent:function(a){var b=this.component,c=this;this.component=a,this.firePropertyChange("component",b,a),this.addViewPropertyChangeListener(a,this._handleViewPropertyChange),$(this._view).resize(function(){var a=$(this._view).width(),b=$(this._view).height();c.component.adjustBounds({x:0,y:0,width:a,height:b}),c.invalidate()})},getAbsPostion:function(a){for(var b=0,c=0;a=a.offsetParent;)b+=a.offsetTop,c+=a.offsetLeft;return{left:c,top:b}},_initRuler:function(){this._topRuler.visible=!0,this._leftRuler.visible=!0,this._topRuler.style.borderBottom="1px solid "+this._lineColor,this._topRuler.style.borderLeft="1px solid "+this._lineColor,this._leftRuler.style.borderRight="1px solid "+this._lineColor,this._leftRuler.style.borderTop="1px solid "+this._lineColor},_drawRuler:function(){var a=this.getComponentViewRect(),b=this.getComponentZoom();this.calculateGap(b);var c=this.getGap(),d=a.x,e=a.y,g=a.width,h=a.height,i=d%(5*c),d=d-i-5*c-1,j=Math.round((a.x-i-5*c)/b),k=d-a.x;1===Math.abs(Math.round(d/(5*c))%2)&&(k-=5*c,j-=5*this._defaultGap);var l=g+10*c;if(a&&this._topRuler.visible){var m=f.transformAndScaleCanvasContext(this._topRuler);this._drawHRuler(m,k,j,c,l,this._rulerWidth)}var n=e%(5*c),e=e-n-5*c-1,o=Math.round((a.y-n-5*c)/b),p=e-a.y;1===Math.abs(Math.round(e/(5*c))%2)&&(p-=5*c,o-=5*this._defaultGap);var q=h+10*c;if(a&&this._leftRuler.visible){var m=f.transformAndScaleCanvasContext(this._leftRuler);this._drawVRuler(m,p,o,c,q,this._rulerWidth)}},_drawHRuler:function(a,b,c,d,e,f){a.clearRect(b,0,e,f),a.save(),a.strokeStyle=this._lineIntervalLineColor,a.beginPath(),a.lineWidth=1;for(var g=1,h=f,i=f-6,j=(this.getComponentZoom(),b+d);b+e>j;j+=d)i=f-6,g%5==0&&(i=f-10),g%10!==0&&(a.moveTo(j,h),a.lineTo(j,i)),g++;a.closePath(),a.stroke(),g=1,a.beginPath(),a.strokeStyle=this._lineColor;for(var j=b+d;b+e>j;j+=d)g%10===0&&(i=1,a.moveTo(j,h),a.lineTo(j,i)),g++;a.stroke(),a.restore(),a.save(),a.textBaseline="middle",a.font="11px Arial",a.fillStyle=this._lineColor;for(var k=c,l=b;b+e>l;l+=10*d,k+=10*this._defaultGap)a.fillText(k,l+5,8);a.restore(),this._showGuides&&this._mousePoint&&(a.save(),a.strokeStyle="#f07819",a.lineWidth=3,a.beginPath(),a.moveTo(this._mousePoint.x,0),a.lineTo(this._mousePoint.x,20),a.stroke(),a.restore())},_drawVRuler:function(a,b,c,d,e,f){a.clearRect(0,b,f,e),a.save(),a.strokeStyle=this._lineIntervalLineColor,a.beginPath(),a.lineWidth=1;for(var g=1,h=f,i=f-6,j=(this.getComponentZoom(),b+d);b+e>j;j+=d)i=f-6,g%5==0&&(i=f-10),g%10!==0&&(a.moveTo(h,j),a.lineTo(i,j)),g++;a.closePath(),a.stroke(),a.restore(),g=1,a.beginPath(),a.strokeStyle=this._lineColor;for(var j=b+d;b+e>j;j+=d)g%10===0&&(i=1,a.moveTo(h,j),a.lineTo(i,j)),g++;a.stroke(),a.restore(),a.save(),a.textBaseline="middle",a.textAlign="left",a.font="11px Arial",a.fillStyle=this._lineColor;for(var k=c,l=b;b+e>l;l+=10*d,k+=10*this._defaultGap){a.save();var m=_twaver.g.getTextSize(a.font,k),n={x:2,y:l-8,width:m.width,height:m.height};a.translate(n.x,n.y),a.rotate(3*Math.PI/2),a.translate(-n.x,-n.y),a.fillText(k,0,l-2),a.restore()}a.restore(),this._showGuides&&this._mousePoint&&(a.save(),a.strokeStyle="#f07819",a.lineWidth=3,a.beginPath(),a.moveTo(0,this._mousePoint.y),a.lineTo(20,this._mousePoint.y),a.stroke(),a.restore())},getComponentZoom:function(){return this.component.getZoom()||1},getGap:function(){var a=this.getComponentZoom();return this._defaultGap*a},calculateGap:function(a){.17>a?this._defaultGap=50:.5>a?this._defaultGap=20:.9>a?this._defaultGap=10:3.2>a?this._defaultGap=5:this._defaultGap=1},setShowGuides:function(a){this._showGuides;this._showGuides=a,this._drawRuler()},isShowGuides:function(){return this._showGuides},setShowRuler:function(a){var b=this._topRuler.visible;this._topRuler.visible=a,this._leftRuler.visible=a,a?(this.hasChildNode(this._view,this._topRuler)||this._view.appendChild(this._topRuler),this.hasChildNode(this._view,this._leftRuler)||this._view.appendChild(this._leftRuler)):(this.hasChildNode(this._view,this._topRuler)&&this._view.removeChild(this._topRuler),this.hasChildNode(this._view,this._leftRuler)&&this._view.removeChild(this._leftRuler)),this.firePropertyChange("showRuler",b,a)},hasChildNode:function(a,b){var c=a.childNodes;for(var d in c)if(c[d]==b)return!0;return!1},getComponentViewRect:function(){return this.component.getViewRect?this.component.getViewRect():null},addViewPropertyChangeListener:function(a,b){a&&a.addPropertyChangeListener&&a.addPropertyChangeListener(b,this)},_handleViewPropertyChange:function(a){"viewRect"==a.property&&this._drawRuler()},createElement:function(a){return document.createElement(a)},validateImpl:function(){var a=this._view.offsetWidth,b=this._view.offsetHeight,c=0,d=0,e=0,g=0,h=0,i=0,j=a,k=b;this._topRuler.visible&&(c=this._rulerWidth,g=this._rulerWidth,i=this._rulerWidth),this._leftRuler.visible&&(d=this._rulerWidth,e=this._rulerWidth,h=this._rulerWidth),j=a-d,k=b-c,this._topRuler.visible&&(this._topRuler.width=j,this._topRuler.height=c,_twaver.setViewBounds(this._topRuler,{x:e,y:0,width:j,height:c}),f.transformAndScaleCanvasContext(this._topRuler,!0)),this._leftRuler.visible&&(this._leftRuler.width=d,this._leftRuler.height=k,_twaver.setViewBounds(this._leftRuler,{x:0,y:g,width:d,height:k}),f.transformAndScaleCanvasContext(this._leftRuler,!0)),this.component&&(_twaver.setViewBounds(this.component,{x:h,y:i,width:j,height:k}),f.transformAndScaleCanvasContext(this.component._rootCanvas,!0)),this._drawRuler()},getView:function(){return this._view},left:function(a){this._view.style.left=a+"px",this.invalidate()}});var m=function(a){m.superClass.constructor.call(this,a),this.currentItem=null,this.pasteOffsetDz=0,this.parentNode=null,this.model3dTo2dMapping=i.deviceEditorModel3dTo2dMapping,this.model2dTo3dMapping=i.deviceEditorModel2dTo3dMapping,this.copyChildNode=null,this.lastSelectedChildNode=null,this._editable=!1,this.isAddChildNode=!1,this.KEY_CODE_COPY_ONE=81,this.PANEL_CATEGORY="设备面板",this.init()};m.prototype={init:function(){var a=this;this.accordionPane=new c.AccordionPane,this.network2dView=this._initNetwork2d(),this.network2d.setMaxZoom(40);var b=this.sheet=new twaver.controls.PropertySheet(this.box);f.initPropertySheet(b);var d=this.propertySheetBox.width(),e=this.propertySheetBox.height();b.adjustBounds({x:0,y:0,width:d,height:e}),this.propertySheetBox.append(this.sheet.getView()),this.accordionPaneBox.append(this.accordionPane.getView()),this.networkBox.append(this.network2dView),this.copyChildNode=this._createCopyChildNode(),this.addKeyMoveListener(this.network2d),$(this.network2dView).on("mousemove",function(b){if(a.copyChildNode){var c=a.network2d.getLogicalPoint(b);a.copyChildNode.setCenterLocation(c)}}),$(document).on("keyup",function(b){b.keyCode==a.KEY_CODE_COPY_ONE&&a.box.contains(a.copyChildNode)&&a.box.remove(a.copyChildNode)}),$(this.network2dView).on("keydown",function(b){if(32==b.keyCode){var c=a.box.getSelectionModel().getLastData();if(!c)return;var d=c.getAngle();c.setAngle(d+90)}else if(b.keyCode==a.KEY_CODE_COPY_ONE&&a.lastSelectedChildNode&&!a.box.contains(a.copyChildNode)){var e=a.lastSelectedChildNode.getSize(),d=a.lastSelectedChildNode.getAngle();a.copyChildNode.setSize(e),a.copyChildNode.setAngle(d),a.copyChildNode.setClient("id",a.lastSelectedChildNode.getClient("id")),a.box.add(a.copyChildNode)}else 8==b.keyCode&&b.preventDefault()}),$(this.network2dView).on("dblclick",function(b){a.network2d.setDefaultInteractions()}),$(this.network2dView).on("click",function(b){if(a.box.contains(a.copyChildNode)){var c=a.copyChildNode.getClient("id"),d=a.network2d.getLogicalPoint(b),e=a.copyChildNode.getSize(),f=a.copyChildNode.getAngle(),g=[d.x,d.y,0];g[0]-=e.width/2,g[1]-=e.height/2;var h={position:g,rotation:[0,0,f],width:e.width,height:e.height};return a.loadChild(c,h),b.preventDefault(),!1}}),this.refreshAccordion()},_initNetwork2d:function(){var a=this,b=this.network2d=new d.edit.GridNetwork;this.network2d.setPositionMagneticX(5),this.network2d.setPositionMagneticY(5),this.network2d.setEditableFunction(function(b){return!a.isHost(b)&&a.copyChildNode!=b||a.isResizeable(b)});var c=this.box;this.network2d.getView().addEventListener("keydown",function(b){var d=!1,e=a.network2d.getPositionMagneticX(),g=a.network2d.getPositionMagneticY();37==b.keyCode&&(f.moveSelectionElements(c,"left",e,g),d=!0),38==b.keyCode&&(f.moveSelectionElements(c,"top",e,g),d=!0),39==b.keyCode&&(f.moveSelectionElements(c,"right",e,g),d=!0),40==b.keyCode&&(f.moveSelectionElements(c,"bottom",e,g),d=!0),d&&(b.preventDefault(),b.stopPropagation())});var c=this.box=this.network2d.getElementBox(),e=this.packQuickFinder=new twaver.QuickFinder(this.box,"pack","client"),g=this.selectionModel=this.box.getSelectionModel();g.addSelectionChangeListener(function(b){var c=g.getLastData();clearTimeout(a.selectionChangeHandleTimer),a.selectionChangeHandleTimer=setTimeout(function(){a._resetPropertySheet(),a.lastSelectedChildNode=null,c&&!a.isHost(c)&&(a.lastSelectedChildNode=c),a.parentNode&&(a.network2d.isSelected(a.parentNode)?a.parentNode.setStyle("whole.alpha",1):g.size()>0?a.parentNode.setStyle("whole.alpha",.3):a.parentNode.setStyle("whole.alpha",1))},100);var d=g.getSelection();if(d&&0!=d.size()){var f=c.getClient("pack");if(f){var h=e.find(f);if(d)for(var i=0;i<d.size();i++){var j=d.get(i);h.contains(j)||(g.removeSelection(j),i--)}h.forEach(function(a){g.contains(a)||g.appendSelection(a)},this)}}}),g.setFilterFunction(function(b){return a.isEditable(b)});var h=c.getLayerBox(),i=this.parentLayer=new twaver.Layer("parentLayer"),j=this.childrenLayer=new twaver.Layer("childrenLayer");h.add(i),h.add(j),h.moveToTop(i);var l=this.network2d.getView();k.setDropTarget(l,{self:this,dropEffect:"copy",ondrop:function(d,e){e=JSON.parse(e);var f=e.id;if(!a.onDropHandler||!a.onDropHandler(d,e,c,b)){var g=make.Default.getOtherParameter(f,"category");if(g==a.PANEL_CATEGORY)return void a.setData(make.Default.load(f));var h=a.network2d.getLogicalPoint(d),i=make.Default.getOtherParameter(a.getEditId(f),"host"),j={position:[h.x,h.y,0],centerLocation:{x:h.x,y:h.y}},k=null;i?(k=a.loadParent(f,j),setTimeout(function(){a.network2d.zoomOverview()},100)):k=a.loadChild(f,j),k&&(a.selectionModel.clearSelection(),a.selectionModel.setSelection(k),a._resetPropertySheet())}},ondragover:function(a){},ondragleave:function(a){}});var m=this.ruler=new d.edit.Ruler(this.network2d);m.getView().setAttribute("class","room-ruler"),m.setShowGuides(!1),m.setShowRuler(!0);var n=$(m.getView());return n},onDropHandler:function(a,b,c,d){},getEditId:function(a){return f.getDeviceEditorModel2dId(a)},isEditable:function(a){return a.getClient("editable")===!0?!0:!this.isHost(a)},isHost:function(a){return!!a.getClient("host")},isResizeable:function(a){return!!a.getClient("resizeable")},_createCopyChildNode:function(){var a=new twaver.Node;return a.setLayerId(this.childrenLayer.getId()),a.setStyle("body.type","vector"),a.setStyle("vector.shape","rectangle"),a.setStyle("vector.fill",!1),a.setStyle("vector.outline.width",2),a.setStyle("vector.outline.color","#a0a819"),a},loadChildren:function(a){var b=[],c=this,d=[];if(a instanceof Array)a.forEach(function(a){if(make.Default.getOtherParameter(a.id,"link"))d.push(a);else{var e=c.loadChild(a.id,a);b.push(e)}}),d.forEach(function(a){var d=c.loadChild(a.id,a);b.push(d)});else{var e=c.loadChild(a.id,a);b.push(e)}return b},loadChild:function(a,b){this.parentNode||console.warn("parentNode is null");var d=this;a=a.replace("."+i.DEVICE_MODEL_SUFFIX,""),b.id=this.getEditId(a),b.objectId=c.id();var e=make.Default.load(b);if(make.Default.getOtherParameter(b.id,"link")){var f=e;f.setFromNode(d.findByBID(b.from)),f.setToNode(d.findByBID(b.to)),d.box.add(f)}else if(e instanceof Array){var g=e;g.forEach(function(a){a.setLayerId(d.childrenLayer.getId()),d.parentNode&&a.setHost(d.parentNode),d.box.add(a)})}else{var h=e;h.setLayerId(d.childrenLayer.getId()),d.parentNode&&h.setHost(d.parentNode),d.box.add(h)}return e},loadParent:function(a,b){a=a.replace("."+i.DEVICE_MODEL_SUFFIX,""),b.id=this.getEditId(a),b.objectId=c.id(),this.box.clear();var d=make.Default.load(b);return d.setLayerId(this.parentLayer.getId()),d.setLocation(0,0),d.setMovable(!1),this.parentNode=d,this.startBatch(),this.box.add(d),this.endBatch(),d},setData:function(a){for(var b=this,c=[],d=0;d<a.length;d++){var e=a[d];make.Default.getOtherParameter(e.id,"link")?c.push(e):0==d&&make.Default.getOtherParameter(e.id,"host")?b.loadParent(e.id,e):b.loadChild(e.id,e)}c.forEach(function(a){b.loadChild(a.id,a)})},clear:function(){this.box.clear()},_resetPropertySheet:function(){if(this.isPropertySheetVisible()){var a=this,b=a.sheet.getPropertyBox();b.clear();var c=this.box.getSelectionModel();if(1!=c.size())b.clear(),this.propertySheetBox.hide();else{this.propertySheetBox.show();var d=c.getLastData();f.addProperties(b,make.Default.getModelDefaultParameterProperties(make.Default.getId(d))),a.resetPropertySheetBoxSize(this.sheet)}}},align:function(a){var b=this;if(a){var c=this.selectionModel.getSelection(),d=new twaver.List;c.forEach(function(a){a&&!b.isHost(a)&&d.add(a)}),!d||d.size()<2||make.Default.align(d,a)}},flow:function(a,b){var c=this;if(a){var d=this.selectionModel.getSelection(),e=new twaver.List;d.forEach(function(a){a&&!c.isHost(a)&&e.add(a)}),!e||e.size()<2||make.Default.flow(e,a,b)}},zoomOverview:function(){this.network2d.zoomOverview()},setMouseEditable:function(a){var b=this._editable;b!=a&&(this._editable=a,this._editable?this.network2d.setInteractions([new twaver.vector.interaction.DefaultInteraction(this.network2d),new twaver.vector.interaction.EditInteraction(this.network2d)]):this.network2d.setInteractions([new twaver.vector.interaction.DefaultInteraction(this.network2d)]))},setDragToPan:function(a){this.network2d.setDragToPan(a)},getData:function(){var a=[],b=this;return this.box.forEach(function(c){if(c==b.parentNode){var d=make.Default.toJson(c);a.splice(0,0,d)}else{var d=make.Default.toJson(c);a.push(d)}}),a},appendData:function(a){this.loadChildren(a)},removeData:function(a){var b=this;return a instanceof Array?a.map(function(a){return b.box.removeById(a.objectId)}):b.box.removeById(a.objectId)},getSelectedData:function(){var a=this,b=[],c=this.selectionModel.getSelection().toList();return c&&c.size()>0&&c.forEach(function(c){if(!a.isHost(c)){var d=make.Default.toJson(c);b.push(d)}}),b},refreshAccordion:function(a){a=a||c.utils.load2dDeviceCategory(),this.accordionPane.setCategories(a)}},c.DeviceEditor=m,c.utils.ext(m,l),CircuitCreateLinkInteraction=function(a,b){CircuitCreateLinkInteraction.superClass.constructor.call(this,a,b)},twaver.Util.ext("CircuitCreateLinkInteraction",twaver.vector.interaction.CreateLinkInteraction,{paint:function(a){a.beginPath();a.lineWidth=this.network.getEditLineWidth(),this.currentPoint&&this.paintLine(a),a.closePath()},paintLine:function(a){var b=this.network.getEditLineColor(),c=this.fromNode.hotPoint.x,d=this.fromNode.hotPoint.y,e=this.currentPoint.x,f=this.currentPoint.y,g=this.network.getViewRect();isFoleLink?(a.strokeStyle=b,a.beginPath(),a.moveTo(c-g.x,d-g.y),a.lineTo(e,d-g.y),a.lineTo(e,f),a.stroke()):(a.strokeStyle=b,a.beginPath(),a.moveTo(c-g.x,d-g.y),a.lineTo(e,f),a.stroke())},clear:function(){this.currentPoint=null,this.currentNode=null,this.fromNode=null,this.toNode=null,this.lastNode=null},handle_mousedown:function(a){if(this.network.isValidEvent(a)){if(this.fromNode){if(this.toNode=this.currentNode,this.toNode instanceof twaver.HorizontalLine){var b=this.createLink(),c=this.toNode.getClient("IntersectionPointOffset")||0;b.s("link.to.percent",[c,0]),b&&this.network.addElementByInteraction(b),this.lastNode.setClient("IntersectionPoint",null)}else if(this.toNode instanceof twaver.VerticalLine){var b=this.createLink(),c=this.toNode.getClient("IntersectionPointOffset")||0;b.s("link.to.percent",[0,c]),b&&this.network.addElementByInteraction(b),this.lastNode.setClient("IntersectionPoint",null)}else if(this.toNode instanceof twaver.Node){var d=this.network.getElementUI(this.toNode);if(!d)return;var e=d._hotPoint1,f=d._hotPoint2;if(!e||!f)return;var g=this.network.getLogicalPoint2(a);Math.pow(g.x-e.x,2)+Math.pow(g.y-e.y,2)<Math.pow(g.x-f.x,2)+Math.pow(g.y-f.y,2)?this.toNode.hotPoint=e:this.toNode.hotPoint=f;var b=this.createLink();b&&this.network.addElementByInteraction(b)}this.clear()}else{this.fromNode=this.currentNode,this.currentNode=null,this.currentPoint=null,this.repaint();var d=this.network.getElementUI(this.fromNode);if(!d)return;var e=d._hotPoint1,f=d._hotPoint2;if(!e||!f)return;var g=this.network.getLogicalPoint2(a);Math.pow(g.x-e.x,2)+Math.pow(g.y-e.y,2)<Math.pow(g.x-f.x,2)+Math.pow(g.y-f.y,2)?this.fromNode.hotPoint=e:this.fromNode.hotPoint=f}if(this.lastNode){var h=this.lastNode;h.setClient("drawIntersectionPoint1",!1),h.setClient("drawIntersectionPoint2",!1),h.setClient("IntersectionPoint",null)}}},handle_mousemove:function(a){var b=this.getMarkerPoint(a);if(b){if(this.network.isMovingElement()||this.network.isEditingElement())return void this.clear();var c=null;if(this.fromNode){if(this.currentNode=this.getToNode(a,this.fromNode),this.currentPoint=b,this.repaint(),this.currentNode instanceof twaver.HorizontalLine){var d=this.currentNode.getPoints();if(2!==d.size())return;var e=this.network.getLogicalPoint2(a),f=this.currentNode.getLineLength(),g=Math.abs(e.x-d.get(0).x)/f;this.currentNode.setClient("IntersectionPointOffset",g),Math.abs(g)>0&&Math.abs(g)<1&&(g*=f);var h={x:d.get(0).x+g,y:d.get(0).y};this.currentNode.setClient("IntersectionPoint",h),this.lastNode=this.currentNode,this.currentNode.hotPoint=h}else if(this.currentNode instanceof twaver.VerticalLine){var d=this.currentNode.getPoints();if(2!==d.size())return;var e=this.network.getLogicalPoint2(a),f=this.currentNode.getLineLength(),i=Math.abs(e.y-d.get(0).y)/f;this.currentNode.setClient("IntersectionPointOffset",i),Math.abs(i)>0&&Math.abs(i)<1&&(i*=f);var h={x:d.get(0).x,y:d.get(0).y+i};this.currentNode.setClient("IntersectionPoint",h),this.lastNode=this.currentNode,this.currentNode.hotPoint=h}else if(this.currentNode instanceof twaver.Node){if(!this.currentNode.getClient("connectable"))return;var j=this.network.getElementUI(this.currentNode),k=j._hotPoint1,l=j._hotPoint2;if(this.lastNode=this.currentNode,!k||!l)return;var e=this.network.getLogicalPoint2(a);Math.pow(e.x-k.x,2)+Math.pow(e.y-k.y,2)<Math.pow(e.x-l.x,2)+Math.pow(e.y-l.y,2)?this.currentNode.setClient("drawIntersectionPoint1",!0):this.currentNode.setClient("drawIntersectionPoint2",!0)}else if(this.lastNode){var m=this.lastNode;m.setClient("drawIntersectionPoint1",!1),m.setClient("drawIntersectionPoint2",!1),m.setClient("IntersectionPoint",null)}}else if(c=this.getFromNode(a),this.currentNode!==c)if(this.currentNode=c,c instanceof twaver.Node){if(this.lastNode=c,!c.getClient("connectable"))return;var j=this.network.getElementUI(c),k=j._hotPoint1,l=j._hotPoint2;if(!k||!l)return;var e=this.network.getLogicalPoint2(a);Math.pow(e.x-k.x,2)+Math.pow(e.y-k.y,2)<Math.pow(e.x-l.x,2)+Math.pow(e.y-l.y,2)?c.setClient("drawIntersectionPoint1",!0):c.setClient("drawIntersectionPoint2",!0)}else if(this.lastNode){var m=this.lastNode;m.setClient("drawIntersectionPoint1",!1),m.setClient("drawIntersectionPoint2",!1)}}},getNode:function(a,b){var c=this.network.getElementAt(a);return c instanceof twaver.Node&&this.network.isLinkable(c,b)&&this.network.getElementBox().getSelectionModel().isSelectable(c)?c:null}}),CircuitCreatePolyLineInteraction=function(a,b){CircuitCreatePolyLineInteraction.superClass.constructor.call(this,a,b)},twaver.Util.ext("CircuitCreatePolyLineInteraction",twaver.vector.interaction.CreateShapeNodeInteraction,{handle_mousedown:function(a){if(0===a.button){var b=this.network.getLogicalPoint2(a);if(b){if(2===a.detail||a.timeStamp-this.timeStamp<300){if(this.points){var c=this.shapeNodeFunction(this.points);this.network.addElementByInteraction(c),this.clear();var d=this;setTimeout(function(){d.network.setEditingElement(!1)},0)}}else{if(this.network.isEditingElement()||this.network.setEditingElement(!0),this.points||(this.points=new twaver.List),this.points.size()>0){var e=this.points.get(this.points.size()-1);if(e.x===b.x&&e.y===b.y)return;Math.abs(b.x-e.x)>=Math.abs(b.y-e.y)?b.y=e.y:b.x=e.x}this.points.add(b)}this.timeStamp=a.timeStamp,this.repaint()}}},handle_mousemove:function(a){this.points&&(this.currentPoint=this.network.getLogicalPoint2(a),this.repaint())}});var n=function(a){n.superClass.constructor.call(this,a),this.currentItem=null,this.parentNode=null,this.model3dTo2dMapping=i.circuitEditorModel3dTo2dMapping,this.model2dTo3dMapping=i.circuitEditorModel2dTo3dMapping,this.copyChildNode=null,this.lastSelectedChildNode=null,this._editable=!1,this.isAddChildNode=!1,this.KEY_CODE_COPY_ONE=0,this.PANEL_CATEGORY="设备面板",this.init()};n.prototype={init:function(){var a=this;this.accordionPane=new c.AccordionPane,this.network2dView=this._initNetwork2d(),this.network2d.setMaxZoom(40);var b=this.sheet=new twaver.controls.PropertySheet(this.box);f.initPropertySheet(b);var d=this.propertySheetBox.width(),e=this.propertySheetBox.height();b.adjustBounds({x:0,y:0,width:d,height:e}),this.propertySheetBox.append(this.sheet.getView()),this.accordionPaneBox.append(this.accordionPane.getView()),this.networkBox.append(this.network2dView),this.copyChildNode=this._createCopyChildNode(),$(this.network2dView).on("mousemove",function(b){if(a.copyChildNode){var c=a.network2d.getLogicalPoint(b);a.copyChildNode.setCenterLocation(c)}}),$(document).on("keyup",function(b){b.keyCode==a.KEY_CODE_COPY_ONE&&a.box.contains(a.copyChildNode)&&a.box.remove(a.copyChildNode)}),$(this.network2dView).on("keydown",function(b){if(32==b.keyCode){var c=a.box.getSelectionModel().getLastData();if(!c)return;var d=c.getAngle();c.setAngle(d+90)}else if(b.keyCode==a.KEY_CODE_COPY_ONE&&a.lastSelectedChildNode&&!a.box.contains(a.copyChildNode)){var e=a.lastSelectedChildNode.getSize(),d=a.lastSelectedChildNode.getAngle();a.copyChildNode.setSize(e),a.copyChildNode.setAngle(d),a.copyChildNode.setClient("id",a.lastSelectedChildNode.getClient("id")),a.box.add(a.copyChildNode)}else 8==b.keyCode&&b.preventDefault()}),$(this.network2dView).on("dblclick",function(b){a.network2d.setDefaultInteractions()}),$(this.network2dView).on("click",function(b){if(a.box.contains(a.copyChildNode)){var c=a.copyChildNode.getClient("id"),d=a.network2d.getLogicalPoint(b),e=a.copyChildNode.getSize(),f=a.copyChildNode.getAngle(),g={centerLocation:{x:d.x,y:d.y},width:e.width,height:e.height,angle:f};return a.loadChild(c,g),b.preventDefault(),!1}}),this.refreshAccordion()},_initNetwork2d:function(){var a=this,b=this.network2d=new d.edit.GridNetwork;this.network2d.setPositionMagneticX(5),this.network2d.setPositionMagneticY(5),this.network2d.setWheelToZoom(!1),this.network2d.setPositionMagneticEnabled(!1),this.network2d.setEditableFunction(function(b){return!a.isHost(b)&&a.copyChildNode!=b||a.isResizeable(b)});var c=this.box=this.network2d.getElementBox(),e=this.selectionModel=this.box.getSelectionModel();e.addSelectionChangeListener(function(b){clearTimeout(a.selectionChangeHandleTimer),a.selectionChangeHandleTimer=setTimeout(function(){a._resetPropertySheet(),a.lastSelectedChildNode=null;var b=e.getLastData();b&&!a.isHost(b)&&(a.lastSelectedChildNode=b),a.parentNode&&(a.network2d.isSelected(a.parentNode)?a.parentNode.setStyle("whole.alpha",1):e.size()>0?a.parentNode.setStyle("whole.alpha",.3):a.parentNode.setStyle("whole.alpha",1)),a.network2d.invalidate()},100)}),e.setFilterFunction(function(b){return a.isEditable(b)});var f=c.getLayerBox(),g=this.parentLayer=new twaver.Layer("parentLayer"),h=this.childrenLayer=new twaver.Layer("childrenLayer");f.add(g),f.add(h),f.moveToTop(g);var i=this.network2d.getView();k.setDropTarget(i,{self:this,dropEffect:"copy",ondrop:function(d,e){e=JSON.parse(e);var f=e.id;if(!a.onDropHandler||!a.onDropHandler(d,e,c,b)){var g=make.Default.getOtherParameter(f,"category");if(g==a.PANEL_CATEGORY)return void a.setData(make.Default.load(f));var h=a.network2d.getLogicalPoint(d),i=make.Default.getOtherParameter(a.getEditId(f),"host"),j={centerLocation:{x:h.x,y:h.y}},k=null;i?(k=a.loadParent(f,j),setTimeout(function(){a.network2d.zoomOverview()},100)):k=a.loadChild(f,j),k&&(a.selectionModel.clearSelection(),a.selectionModel.setSelection(k),a._resetPropertySheet())}},ondragover:function(a){},ondragleave:function(a){}});var j=this.ruler=new d.edit.Ruler(this.network2d);j.getView().setAttribute("class","room-ruler"),j.setShowGuides(!1),j.setShowRuler(!0);var l=$(j.getView());return l},onDropHandler:function(a,b,c,d){var e=b.id,f=make.Default.getOtherParameter(e,"interaction");if("createPolyLink"===f)d.setInteractions([new CircuitCreatePolyLineInteraction(d,function(a){var b=make.Default.load(e);return b.setPoints(a),b}),new twaver.vector.interaction.DefaultInteraction(d)]);else if("createLink"==f)return isFoleLink=!1,d.setInteractions([new CircuitCreateLinkInteraction(d,function(a,b){var c,d=a.getCenterLocation(),f=b.getCenterLocation(),g="arc";if(b instanceof twaver.HorizontalLine){if(a.hotPoint)if(a.hotPoint.x>d.x)c=[1,.5];else if(a.hotPoint.x<d.x)c=[0,.5];else if(a.hotPoint.y>d.y){c=[.5,1];var h={x:a.hotPoint.x,y:a.hotPoint.y+30}}else{c=[.5,0];var h={x:a.hotPoint.x,y:a.hotPoint.y-30}}else c=[.5,.5];var i=make.Default.load({id:e,style:{"link.from.percent":c,"link.bundle.enable":!1,"link.type":"arc","link.corner":"none"},client:{"link.type":"HorizontalLine",fromControlPoint:h}});return i.setFromNode(a),i.setToNode(b),i}if(b instanceof twaver.VerticalLine){c=a.hotPoint?a.hotPoint.x>d.x?[1,.5]:a.hotPoint.x<d.x?[0,.5]:a.hotPoint.y>d.y?[.5,1]:[.5,0]:[.5,.5];var i=make.Default.load({id:e,style:{"link.from.percent":c,"link.bundle.enable":!1,
"link.type":"arc","link.corner":"none"},client:{"link.type":"VerticalLine"}});return i.setFromNode(a),i.setToNode(b),i}if(a.hotPoint&&b.hotPoint){a.hotPoint.x>d.x&&b.hotPoint.x<f.x?g="orthogonal.horizontal":a.hotPoint.x>d.x&&b.hotPoint.x>f.x?g="extend.right":a.hotPoint.x>d.x?g="orthogonal.H.V":a.hotPoint.x<d.x&&b.hotPoint.x<f.x?g="extend.left":a.hotPoint.x<d.x&&b.hotPoint.x>f.x?g="orthogonal.horizontal":a.hotPoint.x<d.x?g="orthogonal.H.V":a.hotPoint.y>d.y&&b.hotPoint.y<f.y?g="orthogonal.vertical":a.hotPoint.y>d.y&&b.hotPoint.y>f.y?g="extend.bottom":a.hotPoint.y>d.y?g="orthogonal.V.H":a.hotPoint.y<d.y&&b.hotPoint.y<f.y?g="extend.top":a.hotPoint.y<d.y&&b.hotPoint.y>f.y?g="orthogonal.vertical":a.hotPoint.y<d.y&&(g="orthogonal.V.H");var i=make.Default.load({id:e,style:{"link.type":g,"link.corner":"none"}});return i.setFromNode(a),i.setToNode(b),i}}),new twaver.vector.interaction.DefaultInteraction(d)]),!0},getEditId:function(a){return f.getDeviceEditorModel2dId(a)},isEditable:function(a){return a.getClient("editable")===!0?!0:!this.isHost(a)},isHost:function(a){return!!a.getClient("host")},isResizeable:function(a){return!!a.getClient("resizeable")},_createCopyChildNode:function(){var a=new twaver.Node;return a.setLayerId(this.childrenLayer.getId()),a.setStyle("body.type","vector"),a.setStyle("vector.shape","rectangle"),a.setStyle("vector.fill",!1),a.setStyle("vector.outline.width",2),a.setStyle("vector.outline.color","#a0a819"),a},loadChildren:function(a){var b=[],c=this,d=[];if(a instanceof Array)a.forEach(function(a){if(make.Default.getOtherParameter(a.id,"link"))d.push(a);else{var e=c.loadChild(a.id,a);b.push(e)}}),d.forEach(function(a){var d=c.loadChild(a.id,a);b.push(d)});else{var e=c.loadChild(a.id,a);b.push(e)}return b},loadChild:function(a,b){this.parentNode||console.warn("parentNode is null");var d=this;a=a.replace("."+i.DEVICE_MODEL_SUFFIX,""),b.id=this.getEditId(a),b.objectId=c.id();var e=make.Default.load(b);if(make.Default.getOtherParameter(b.id,"link")){var f=e;f.setFromNode(d.findByBID(b.from)),f.setToNode(d.findByBID(b.to)),d.box.add(f)}else if(e instanceof Array){var g=e;g.forEach(function(a){a.setLayerId(d.childrenLayer.getId()),d.parentNode&&a.setHost(d.parentNode),d.box.add(a)})}else{var h=e;h.setLayerId(d.childrenLayer.getId()),d.parentNode&&h.setHost(d.parentNode),d.box.add(h)}return h},loadParent:function(a,b){a=a.replace("."+i.DEVICE_MODEL_SUFFIX,""),b.id=this.getEditId(a),b.objectId=c.id(),this.box.clear();var d=make.Default.load(b);return d.setLayerId(this.parentLayer.getId()),this.box.add(d),d.setLocation(0,0),d.setMovable(!1),this.parentNode=d,d},setData:function(a){for(var b=this,c=[],d=0;d<a.length;d++){var e=a[d];make.Default.getOtherParameter(e.id,"link")?c.push(e):0==d&&make.Default.getOtherParameter(e.id,"host")?b.loadParent(e.id,e):b.loadChild(e.id,e)}c.forEach(function(a){b.loadChild(a.id,a)})},_resetPropertySheet:function(){if(this.isPropertySheetVisible()){var a=this,b=a.sheet.getPropertyBox();b.clear();var c=this.box.getSelectionModel();if(1!=c.size())b.clear(),this.propertySheetBox.hide();else{this.propertySheetBox.show();var d=c.getLastData();if(!make.Default.getId(d))return;f.addProperties(b,make.Default.getModelDefaultParameterProperties(make.Default.getId(d))),a.resetPropertySheetBoxSize(this.sheet)}}},align:function(a){var b=this;if(a){var c=this.selectionModel.getSelection(),d=new twaver.List;c.forEach(function(a){a&&!b.isHost(a)&&d.add(a)}),!d||d.size()<2||make.Default.align(d,a)}},flow:function(a,b){var c=this;if(a){var d=this.selectionModel.getSelection(),e=new twaver.List;d.forEach(function(a){a&&!c.isHost(a)&&e.add(a)}),!e||e.size()<2||make.Default.flow(e,a,b)}},zoomOverview:function(){this.network2d.zoomOverview()},setMouseEditable:function(a){var b=this._editable;b!=a&&(this._editable=a,this._editable?this.network2d.setInteractions([new twaver.vector.interaction.DefaultInteraction(this.network2d),new twaver.vector.interaction.EditInteraction(this.network2d)]):this.network2d.setInteractions([new twaver.vector.interaction.DefaultInteraction(this.network2d)]))},setDragToPan:function(a){this.network2d.setDragToPan(a)},getData:function(a){var b=[],c=null;this.parentNode&&(c=this.parentNode.getId());var d=this,e=0,f=0;return a&&(e=9999999999,f=9999999999,this.box.forEach(function(a){e=Math.min(e,a.getX()),f=Math.min(f,a.getY())})),this.box.forEach(function(a){if(a==d.parentNode){var g=make.Default.toJson(a,function(a){return a.x=a.x||0,a.y=a.y||0,a.x-=e,a.y-=f,a});b.splice(0,0,g)}else{var g=make.Default.toJson(a,function(a){return a.x-=e,a.y-=f,a.parentObjectId=c,a});b.push(g)}}),b},appendData:function(a){this.loadChildren(a)},removeData:function(a){var b=this;return a instanceof Array?a.map(function(a){return b.box.removeById(a.objectId)}):b.box.removeById(a.objectId)},getSelectedData:function(){var a=this,b=[],c=this.selectionModel.getSelection().toList();return c&&c.size()>0&&c.forEach(function(c){if(!a.isHost(c)){var d=make.Default.toJson(c,function(a){return a});b.push(d)}}),b},refreshAccordion:function(a){a=a||c.utils.load2dCircuitCategory(),this.accordionPane.setCategories(a)},pasteSelection:function(a){var b=this;return this._copyAnchor&&0!=this._copyAnchor.length?(a=a||this._getPasteOffset(),void this._copyAnchor.forEach(function(d){var e=f.clone(d);if(e.objectId=c.id(),e.position){var g=e.position;e.position=[g[0]+a.x,g[1]+a.y,g[2]+a.z]}if(e.location){var h=e.location;h instanceof Array?e.location=[g[0]+a.x,g[1]+a.z]:(e.location.x+=a.x,e.location.y+=a.z)}e.x&&(e.x+=a.x),e.y&&(e.y+=a.z),e.points&&e.points._as.forEach(function(b){b.x+=a.x,b.y+=a.z}),b.appendData(e)})):null}},c.CircuitEditor=n,c.utils.ext(n,l);var o=function(a){o.superClass.constructor.call(this,a),this.jsonObj=null,this._modelChangeDispatcher=new mono.EventDispatcher,this._modelPropertyChangeDispatcher=new mono.EventDispatcher,this._currentModel=null,this.refreshAccordion()};o.prototype={_init:function(){this.accordionPane=new c.AccordionPane,this.propertySheetPane=new d.edit.PropertySheetPane(this.box),this.network3dView=this._initNetwork3d(),this.accordionPaneBox.append(this.accordionPane.getView()),this.propertySheetBox.append(this.propertySheetPane.getView()),this.networkBox.append(this.network3dView),this.addPropertySheetListener(),this.adjustNetwork3dBoundingBox()},parentResizeHandle:function(){o.superClass.parentResizeHandle.call(this),this.invalidate()},addPropertySheetListener:function(){var a=this.propertySheetPane.box;a.addDataPropertyChangeListener(this._handleSheetPropertyChanged,this)},getJsonObject:function(){var a=this.propertySheetPane.getData();return a},setElement:function(a){this.propertySheetPane.setElement(a),this.isPropertySheetVisible()&&(this.propertySheetBox.show(),this.resetPropertySheetBoxSize(this.propertySheetPane.sheet))},importJsonObject:function(a){a.objectId=a.objectId||c.id();var b=this.network3d.getDataBox();b.clear();var d=make.Default.load(a);b.addByDescendant(d),this.setElement(a)},_handleSheetPropertyChanged:function(a){if(this.propertySheetPane._setValued){var b=this.propertySheetPane.getData(),c=make.Default.load(b);this.network3d.getDataBox().clear(),this.network3d.getDataBox().addByDescendant(c),this._currentModel=c,this.fireModelPropertyChange(c,a.property,a.oldValue,a.newValue)}},_initNetwork3d:function(){var a=this.network3d=new mono.Network3D,b=new mono.PerspectiveCamera(30,1.5,50,5e3);a.setCamera(b),a.setClearColor("#000000"),a.setClearAlpha(0),a.setBackgroundImage("./images/bg_network.jpg"),b.p(107,156,609),b.look(new mono.Vec3(0,0,0));var d=a.getDefaultInteraction();d.yLowerLimitAngle=Math.PI/180*2,d.yUpLimitAngle=Math.PI/2,d.maxDistance=1e3,d.minDistance=100,d.zoomSpeed=3,d.panSpeed=.2,a.setInteractions([d]);var e=this.box=a.getDataBox(),f=new mono.PointLight(16777215,.1);f.setPosition(1e3,1e3,1e3),e.add(f),e.add(new mono.AmbientLight("white")),a.getRootView().setAttribute("class","network3d-view");var g=this;return a.getRootView().addEventListener("dblclick",function(b){g._handleDoubleClick(b,a)}),k.setDropTarget(a.getRootView(),{self:this,ondrop:function(d,f){if(!g.onDropHandler||!g.onDropHandler(d,f,e,a)){e.clear();var h=JSON.parse(f);h.objectId=h.objectId||c.id();var i=make.Default.load(h);e.addByDescendant(i),mono.Utils.playCameraAnimation(b,new mono.Vec3(107,156,609),new mono.Vec3(0,0,0),1e3),g.setElement(h),i.setClient("data",f),g.fireModelChange(g._currentModel,i),g._currentModel=i}}}),a.getRootView()},onDropHandler:function(a,b,c,d){},adjustNetwork3dBoundingBox:function(){mono.Utils.autoAdjustNetworkBounds(this.network3d,this.networkBox[0],"clientWidth","clientHeight",0,0)},fireModelChange:function(a,b){this._modelChangeDispatcher.fire({source:this,oldValue:a,newValue:b})},fireModelPropertyChange:function(a,b,c,d){this._modelPropertyChangeDispatcher.fire({source:a,property:b,oldValue:c,newValue:d})},addModelChangeListener:function(a,b,c){this._modelChangeDispatcher.add(a,b,c)},removeModelChangeListener:function(a,b){this._modelChangeDispatcher.remove(a,b)},addModelPropertyChangeListener:function(a,b,c){this._modelPropertyChangeDispatcher.add(a,b,c)},removeModelPropertyChangeListener:function(a,b){this._modelPropertyChangeDispatcher.remove(a,b)},_handleDoubleClick:function(a,b){var c=b.getCamera(),d=b.getDefaultInteraction(),e=f.findFirstObjectByMouse(b,a);if(e){var g=e.element,h=e.point,i=c.getTarget();g.getClient("animation")?make.Default.playAnimation(g,g.getClient("animation")):f.animateCamera(c,d,i,h)}else{var i=c.getTarget(),h=new mono.Vec3(0,0,0);f.animateCamera(c,d,i,h)}},refreshAccordion:function(a){a=a||c.utils.load3dModelCategory(),this.accordionPane.setCategories(a)},invalidate:function(){this.adjustNetwork3dBoundingBox()},getCurrentModel:function(){return this._currentModel},getData:function(){var a=this.getJsonObject();return a?a:null},setData:function(a){a instanceof Array?this.importJsonObject(a[0]):this.importJsonObject(a)},getSelectedData:function(){throw"not support this function[{}]".format("getSelectedData")},appendData:function(){throw"not support this function[{}]".format("appendData")},copySelection:function(){throw"not support this function[{}]".format("copySelection")},pasteSelection:function(){throw"not support this function[{}]".format("pasteSelection")}},c.ModelEditor=o,c.utils.ext(o,l);var p=function(a,b,d){p.superClass.constructor.call(this,a),this.modelClass=b,this.objectId=d||c.id(),this.parentNode=null,this.dragNode=null,this.currentItem=null,this.model3dTo2dMapping=i.rackEditorModel3dTo2dMapping,this.model2dTo3dMapping=i.rackEditorModel2dTo3dMapping,this.unitHeight=make.Default.getUnitHeight()||1,this.offsetX=0,this.offsetY=0,this.isSettingLocation=!1,this.isAddChildNode=!1,this.DEVICE_PATTEN="设备模板",this.RACK_PATTEN="机柜模板",this.accordionPane=new c.AccordionPane,this.init()};p.prototype={init:function(){var b=this;this.accordionPane.ondrag=function(a,d){if(!b.isPatten(d.id)&&!b.currentItem){var e=b.getEditId(d.id);if(make.Default.getOtherParameter(e,"host"))return;b.currentItem=d,b.dragNode=make.Default.load({id:b.getEditId(d.id),objectId:c.id()}),b.dragNode.setClient("id",d.id)}},this.network2dView=this._initNetwork2d(),this.network2d.setMaxZoom(15);var d=this.sheet=new twaver.controls.PropertySheet(this.box);f.initPropertySheet(d);var e=this.propertySheetBox.width(),g=this.propertySheetBox.height();d.adjustBounds({x:0,y:0,width:e,height:g}),this.propertySheetBox.append(this.sheet.getView()),this.accordionPaneBox.append(this.accordionPane.getView()),this.networkBox.append(this.network2dView),this.network2d.addInteractionListener(function(c){if("doubleClickElement"==c.kind){var d=c.element;if(!b.isHost(d)){var e=d.getId(),f=d.getClient("id"),g=d.getClient("panel");a.open("deviceEditor.html?objectId="+e+"&modelClass="+f+"&panelName="+g)}}}),$(this.network2dView).on("keydown",function(a){8==a.keyCode&&a.preventDefault()}),this.refreshAccordion(),this.modelClass&&this.loadParent(this.modelClass)},_initNetwork2d:function(){var a=this,b=this.network2d=new d.edit.GridNetwork;this.network2d.setPositionMagneticEnabled();var c=this.box=this.network2d.getElementBox();this._setChildPositionMagnetic(c);var e=this.selectionModel=this.box.getSelectionModel();e.setSelectionMode("singleSelection"),e.addSelectionChangeListener(function(b){a._resetPropertySheet(),a.resetNodeName()}),e.setFilterFunction(function(b){return b!=a.parentNode});var f=c.getLayerBox(),g=this.parentLayer=new twaver.Layer("parentLayer"),h=this.childrenLayer=new twaver.Layer("childrenLayer");f.add(g),f.add(h),f.moveToTop(g);var i=this.network2d.getView();k.setDropTarget(i,{self:this,dropEffect:"copy",ondrop:function(d,e){if(!a.onDropHandler||!a.onDropHandler(d,e,c,b))if(e=JSON.parse(e),a.isPatten(e.id)){var f=make.Default.getOtherParameter(e.id,"category");if(f==a.RACK_PATTEN){var g=make.Default.load(e.id);a.loadParent(g.parent),a.setData(g.data),setTimeout(function(){a.zoomOverview()},10)}else if(a.parentNode){var g=make.Default.load(e.id);a.setData(g)}else alert("add rack first")}else a.dragNode?(c.getSelectionModel().clearSelection(),c.getSelectionModel().appendSelection(a.dragNode),a.dragNode.setStyle("whole.alpha",1),a._resetPropertySheet(),a.resetChildNodeLocation(a.dragNode)):(a.loadParent(e.id),setTimeout(function(){a.network2d.zoomOverview()},10)),a.dragNode&&(a.dragNode=null,a.currentItem=null)},ondragover:function(b){if(b.dataTransfer.dropEffect="copy",a.dragNode&&!a.isHost(a.dragNode)){var d=a.getSize(a.dragNode);if(!a.parentNode||!a._haveSpace(d,a.dragNode))return void(b.dataTransfer.dropEffect="none");a.dragNode.isAddInBox||(a.dragNode.isAddInBox=!0,a.dragNode.setStyle("whole.alpha",.7),a._initChildNode(a.dragNode,h),c.add(a.dragNode),a.box.getSelectionModel().clearSelection(),a.box.getSelectionModel().appendSelection(a.dragNode));var e=a.network2d.getLogicalPoint(b),f=e.x,g=e.y;g-=a.dragNode.getSize().height/2,e=a.formatLocation(a.dragNode,f,g),e?a.dragNode.setLocation(e.x,e.y):a.resetChildNodeLocation(a.dragNode)}},ondragleave:function(b){a.dragNode&&(a.dragNode.isAddInBox&&c.remove(a.dragNode),a.dragNode=null,a.currentItem=null)}});var j=this.ruler=new d.edit.Ruler(this.network2d);j.getView().setAttribute("class","room-ruler"),j.setShowGuides(!1),j.setShowRuler(!0);var l=$(j.getView());return l},onDropHandler:function(a,b,c,d){},isPatten:function(a){var b=make.Default.getOtherParameter(a,"category");return b==this.DEVICE_PATTEN||b==this.RACK_PATTEN},getEditId:function(a){return f.getRackEditorModel2dId(a)},isHost:function(a){return!!a.getClient("host")},getSize:function(a){return a.getClient("size")||1},setData:function(a){var b=this;a.forEach(function(a){b.loadChild(a.id,a)})},loadChild:function(a,b){b.id=this.getEditId(a);var c=make.Default.load(b);return this._initChildNode(c,this.childrenLayer),this.isAddChildNode=!0,this.box.add(c),this.resetChildNodeLocation(c),c},_initChildNode:function(a,b){var c=this;a.setLayerId(b.getId()),a.setHost(this.parentNode);var d=a.setLocation;a.originalSetLocation=d,a.setLocation=function(b,e){var f=c.formatLocation(a,b,e);f?d.call(a,f.x,f.y):c.resetChildNodeLocation(a)};var e=a.translate;return a.translate=function(b,f){if(c.childNodeLiveMove){c.childNodeLastPointOffset.x+=b,c.childNodeLastPointOffset.y+=f;var g=c.childNodeLastPoint.x+c.childNodeLastPointOffset.x,h=c.childNodeLastPoint.y+c.childNodeLastPointOffset.y,i=c.formatLocation(a,g,h);i?d.call(a,i.x,i.y):c.resetChildNodeLocation(a)}else e.call(a,b,f)},a},loadParent:function(a){var b={id:this.getEditId(a),objectId:this.objectId},c=make.Default.load(b);return this._initParentNode(c,this.parentLayer),this.box.clear(),this.box.add(c),c.setLocation(0,0),this._resetPropertySheet(),c.setMovable(!1),this.parentNode=c,c},_initParentNode:function(a,b){a.setLayerId(b.getId()),this.offsetX=a.getClient("offsetX"),this.offsetY=a.getClient("offsetY"),this.childrenSize=a.getClient("childrenSize")},_findChildren:function(){return this.box.toDatas(function(a){return this.parentNode!=a?a:void 0},this)},_isEmpty:function(a,b,c){var d=this._findChildren();if(!d||0==d.size())return!0;var e=this.parentNode.getClient("childrenSize"),f=d.size(),g=a,h=a+b-1;if(h>e-1)return!1;for(var i=0;f>i;i++){var j=d.get(i);if(c!=j){var k=j.getClient("size"),l=parseInt(j.getClient("loc"))-1,m=l,n=l+k-1;if(!(g>n||m>h))return!1}}return!0},_haveSpace:function(a,b){var c=this._findChildren();if(!c||0==c.size())return!0;for(var d=this.parentNode.getClient("childrenSize")||42,e=0;d-a>=e;e++)if(this._isEmpty(e,a,b))return!0;return!1},_getNextLoc:function(a,b){if(this._haveSpace(a,b))for(var c=this.parentNode.getClient("childrenSize"),d=0;c>d;d++)if(this._isEmpty(d,a,b))return d;throw"there have not enough space for "+a+"U  server"},_setChildPositionMagnetic:function(a){var b=this;a.addDataPropertyChangeListener(function(a){var c=a.property,d=a.source;d.getClient("host")?i.HOST_EDITABLE:"C:loc"==c?(d.eventType="loc",b.changeChildNodeHandler(d,a)):"location"==c&&(b.isSettingLocation?b.isSettingLocation=!1:b.moveChildNodeHandler(d,a))}),a.addDataBoxChangeListener(function(a){var c=a.kind,d=a.data;"add"!=c||d.getClient("host")||b.addChildNodeHandler(d,a)}),this.network2d.addInteractionListener(function(a){var c=b.box.getSelectionModel().getLastData();c&&!c.getClient("host")&&("liveMoveStart"==a.kind?(b.childNodeLiveMove=!0,b.childNodeLastPoint=c.getLocation(),b.childNodeLastPointOffset={x:0,y:0},c.setStyle("whole.alpha",.5)):"liveMoveEnd"==a.kind&&(b.moveChildNodeEndHandler(c,a),delete b.childNodeLiveMove,delete b.childNodeLastPoint,delete b.childNodeLastPointOffset,c.setStyle("whole.alpha",1)))})},_getLoc:function(a,b){var c=this.parentNode.getClient("childrenSize"),d=this.parentNode.getLocation(),e=c*this.unitHeight-(a-d.y-this.offsetY),f=Math.round(e/this.unitHeight);return b||(f=Math.max(0,f),f=Math.min(c-1,f)),f},formatLocation:function(a,b,c){var d=this.parentNode.getLocation(),e=this.parentNode.getClient("childrenSize");c=Math.max(d.y+this.offsetY,c),c=Math.min(d.y+this.offsetY+e*this.unitHeight-a.getSize().height,c);var f=a.getClient("size"),g=this._getLoc(c+a.getSize().height);if(!this._isEmpty(g,f,a))return null;var d=this.parentNode.getLocation(),b=d.x+this.offsetX,c=d.y+(e-1-g+1)*this.unitHeight+this.offsetY-a.getSize().height;return{x:b,y:c,loc:g}},addChildNodeHandler:function(a){if(this.isAddChildNode)return void(this.isAddChildNode=!1);var b=a.getLocation(),c=this._getLoc(b.y+a.getSize().height);a.setClient("loc",c-1)},resetNodeName:function(){this.box.forEach(function(a){a.setName(null)});var a=this.selectionModel.getLastData();if(a&&!this.isHost(a)){a.setStyle("label.position","right.right"),a.setStyle("label.xoffset",10);var b=parseInt(a.getClient("loc")),c=parseInt(a.getClient("size")),d=""+b+"U - "+(b+c-1)+"U";a.setName(d)}},changeChildNodeHandler:function(a,b){if(this.resetNodeName(a),"moveChildNodeHandler-loc"==this.eventType)return void(this.eventType=null);var c=a.getClient("size"),d=parseInt(b.newValue)-1;if(this._isEmpty(d,c,a)){var e=this.parentNode.getClient("childrenSize"),f=this.parentNode.getLocation(),g=f.x+this.offsetX,h=f.y+(e-1-d+1)*this.unitHeight+this.offsetY-a.getSize().height;this.setChildNodeLocation(a,g,h)}else d=this._getNextLoc(c,a),a.setClient("loc",d+1)},moveChildNodeHandler:function(a,b){if(this.eventType)return void(this.eventType=null);var c=this,d=a.getClient("size"),e=null;e=b?parseFloat(b.newValue.y):a.getLocation().y;var f=this._getLoc(e+a.getSize().height);if(this._isEmpty(f,d,a)){var g=parseInt(a.getClient("loc"))-1;g!=f&&(this.eventType="moveChildNodeHandler-loc"),a.setClient("loc",f+1)}setTimeout(function(){c.resetChildNodeLocation(a)},500)},moveChildNodeEndHandler:function(a,b){this.resetChildNodeLocation(a)},setChildNodeLocation:function(a,b,c){var d=this.parentNode.getClient("childrenSize"),e=a.getLocation(),f=this.parentNode.getLocation();c=Math.max(f.y+this.offsetY,c),c=Math.min(f.y+this.offsetY+d*this.unitHeight-a.getSize().height,c),(e.x!=b||e.y!=c)&&(this.isSettingLocation=!0,a.setLocation(b,c))},resetChildNodeLocation:function(a){var b=parseInt(a.getClient("loc"))-1,c=this.parentNode.getClient("childrenSize"),d=this.parentNode.getLocation(),e=d.x+this.offsetX,f=d.y+(c-1-b+1)*this.unitHeight+this.offsetY-a.getSize().height,g=a.getLocation();(g.x!=e||g.y!=f)&&(this.isSettingLocation=!0,a.originalSetLocation(e,f))},_resetPropertySheet:function(){if(this.isPropertySheetVisible()){var a=this,b=a.sheet.getPropertyBox();b.clear();var c=this.box.getSelectionModel();if(0==c.size())b.clear(),this.propertySheetBox.hide();else{this.propertySheetBox.show();var d=c.getLastData();f.addProperties(b,make.Default.getModelDefaultParameterProperties(make.Default.getId(d))),a.resetPropertySheetBoxSize(this.sheet)}}},zoomOverview:function(){this.network2d.zoomOverview()},getData:function(){if(!this.parentNode)return[];var a=[],b=this.parentNode.getId(),c=this;return this.box.forEach(function(d){if(d!=c.parentNode){var e=make.Default.toJson(d,function(a){return a.id=f.getRackEditorModel3dId(a.id),a.parentObjectId=b,a});a.push(e)}}),a},refreshAccordion:function(a){a=a||c.utils.load2dRackCategory(!this.modelClass),this.accordionPane.setCategories(a)}},c.RackEditor=p,c.utils.ext(p,l),d.edit.BoxBridge=function(a,b){this.box2d=a,this.jsonBox=b,this.binded=!1,this.wallChildLayer=300,this.innerWallLayer=200,this.innerWallChildLayer=400,this.refMap2d={},this.refMapJson={},this.isAdjusting=!1},mono.extend(d.edit.BoxBridge,Object,{bind:function(){this.binded||(this.box2d.addDataBoxChangeListener(this._handle2dBoxChange,this),this.box2d.addDataPropertyChangeListener(this._handle2dDataChange,this),this.jsonBox.addDataBoxChangeListener(this._handleJsonBoxChange,this),this.binded=!0)},unbind:function(){this.box2d.removeDataBoxChangeListener(this._handle2dBoxChange,this),this.box2d.removeDataPropertyChangeListener(this._handle2dDataChange,this),this.jsonBox.removeDataBoxChangeListener(this._handleJsonBoxChange,this),this.binded=!1},synchronizeFilter:function(a,b){return!0},_getJsonData:function(a){var b=new d.edit.data.JsonObject({objectId:a.getId()}),c=a.getClient("radius"),e=a.getCenterLocation(),g=a.getAngle(),h=f.getSceneEditorModel3dId(a.getClient("id")),i=a.getPoints&&a.getPoints(),j=a.getClient("objName"),k=a.getClient("wallWidth")||a.getWidth(),l=a.getHeight(),m=a.getClient("height"),n=a.getClient("positionY"),o=a.getClient("label"),p=a.getClient("bid"),q=a.getClient("closed"),r=a.getClient("showFloor"),s=null;a.getParent()&&(s=a.getParent()),b.setParentId(s);var t=a.getClient("pointsY"),u={};if(c&&b.setRadius(c),e&&b.setPosition([e.x,0,e.y]),g&&b.setRotation([0,g,0]),h&&(b.id=h),j&&b.setName(j),k&&b.setWidth(k),l&&b.setDepth(l),m&&b.setHeight(m),q&&b.setClosed(!0),r&&b.setShowFloor(!0),n){var v=b.getPosition()||[0,0,0];b.setPosition(v[0],n,v[2])}if(null!=i&&i.size()>0){for(var w=[],x=0;x<i.size();x++)t?w.push([i.get(x).x-e.x,i[x]||20,i.get(x).y-e.y]):w.push([i.get(x).x-e.x,i.get(x).y-e.y]);b.setData(w)}return o&&(u.label=o),p&&(u.bid=p),b.setClient(u),b},_addJsonData:function(a){if(this.synchronizeFilter(a,null)&&this.box2d.contains(a)){var b=this._getJsonData(a);this.jsonBox.add(b),this.refMapJson[a.getId()]=b}},_removeJsonData:function(a){null!=a&&(this.jsonBox.removeById(a.getId()),delete this.refMapJson[a.getId()]);var b=a.getClient("type");if("door"==b||"window"==b){var c=a.getId();for(var d in this.refMapJson)if(this.refMapJson[d]){var e=this.refMapJson[d].getChildren();if(e&&e.length>0)for(var f=0;f<e.length;f++)e[f].getObjectId()==c&&(this.refMapJson[d].getChildren().splice(e.indexOf(e[f]),1),console.log(this.refMapJson[d]))}}},_handle2dBoxChange:function(a){if(!this.isAdjusting){this.isAdjusting=!0;var b=a.data,c=a.kind;"add"==c?this._addJsonData(b):"remove"==c?this._removeJsonData(b):"clear"==c&&this.jsonBox.clear(),this.isAdjusting=!1}},_handle2dDataChange:function(a){var b=this;if(!this.isAdjusting){this.isAdjusting=!0;var c=a.source,d=a.newValue,e=(a.oldValue,a.property);if(c.getParent()&&("door"==c.getClient("type")||"window"==c.getClient("type"))){var f,g=this.jsonBox.getDataById(c.getParent().getId());if(g.getChildren().forEach(function(a){a.getObjectId()==c.getId()&&(f=a)}),e.startsWith("C:")){w=e.substr(e.indexOf(":")+1),("edgeIndex"==w||"offset"==w)&&(f.client=f.client||{},f.client[w]=d),"length"==w&&f.setWidth(d);var h=c.getCenterLocation(),i=f.getPosition()[1];f.setPosition([h.x,i,h.y]);var j=f.getClient()||{};j[w]=d,f.setClient(j)}}var g=this.jsonBox.getDataById(c.getId());if(!g)return void(this.isAdjusting=!1);if("points"==e){var k=[],l=d,m=c.getCenterLocation(),n=c.getClient("pointsY"),o=c.getSegments();if(o&&o.size()>0&&o.size()>l.size())return;if(o&&o.size()>0)for(var p=0,q=0;p<o.size();p++,q++){var r=o.get(p),s=l.get(q);if("moveto"==r||"lineto"==r)n?k.push([parseInt(s.x-m.x),n[q],parseInt(s.y-m.y)]):k.push([parseInt(s.x-m.x),parseInt(s.y-m.y)]);else if("quadto"==r)if(n){var t=l.get(++q),u=n[q]||0;k.push(["c",parseInt(s.x-m.x),n[q],parseInt(s.y-m.y),parseInt(t.x-m.x),u,parseInt(t.y-m.y)])}else k.push(["c",parseInt(s.x-m.x),parseInt(s.y-m.y),parseInt(t.x-m.x),parseInt(t.y-m.y)])}else for(var p=0;p<l.size();p++)n?k.push([l.get(p).x-m.x,n[p],l.get(p).y-m.y]):k.push([l.get(p).x-m.x,l.get(p).y-m.y]);g.setData(k)}else if("location"==e){var m=c.getCenterLocation(),v=(c.getSize(),g.getPosition()||[0,0,0]);g.setPosition([m.x,v[1],m.y]),b.resetParent(c)}else if("angle"==e)g.setRotation([0,-d,0]);else if("width"==e)g.setWidth(d);else if("height"==e)g.setDepth(d);else if(e.startsWith("C:")){var w=e.substr(e.indexOf(":")+1);if("radius"==w)g.setRadius(d);else if("height"==w)g.setHeight(d);else if("positionY"==w){var v=g.getPosition()||[0,0,0];g.setPosition([v[0],parseInt(d),v[2]])}else if("pointsY"==w){for(var n=d,k=g.getData(),p=0;p<k.length;p++)k[p][1]=n[p];g.setData(k)}else"parentId"==w&&g.setParentId(d);var j=g.getClient()||{};j[w]=d,g.setClient(j)}else if(e.startsWith("S:")){var w=e.substr(e.indexOf(":")+1);"vector.outline.color"==w&&g.setColor(d);var x=g.getStyle()||{};x[w]=d,g.setStyle(x)}this.isAdjusting=!1}},_handleJsonBoxChange:function(a){if(!this.isAdjusting){this.isAdjusting=!0;var b=a.data,c=a.kind;"add"==c?(this.refMapJson[b.getObjectId()]||(this.refMapJson[b.getObjectId()]=b),this._add2dData(b)):"remove"==c?this._remove2dData(b):"clear"==c&&this.box2d.clear(),this.isAdjusting=!1}},_remove2dData:function(a){null!=a&&(this.box2d.removeById(a.getObjectId()),delete this.refMap2d[a.getObjectId()])},_replaceMappingId:function(a){var b={};make.Default.copyProperties(a,b);var c=f.getSceneEditorModel2dId(a.id);b.id=c;var d=a.children;if(b.children=[],d)for(var e in d){var g={};make.Default.copyProperties(d[e],g),g=this._replaceMappingId(g),b.children.push(g)}return b},_add2dData:function(a){var b=this;if(this.synchronizeFilter(null,a)&&this.jsonBox.contains(a)&&!this.box2d.getDataById(a.getObjectId())){var c=this._replaceMappingId(a),d={};c.serializeJson(c,d);var e=make.Default.load(d);if(e.setClient("id",a.id),this.box2d.add(e),e.getChildren&&e.getChildren().size()>0){e.setClient("magnetic.disabled",!0);var f=e.getChildren(),b=this;f.forEach(function(a){b.box2d.getDataById(a.getId())||(a.setClient("magnetic.disabled",!0),b.box2d.add(a))})}this.refMap2d[a.getObjectId()]=e,b.resetParent(e)}},resetParent:function(a){var b=this;if(a.getHost&&a.setHost){var c=this.getParent(a);if(c){if(c!=a.getHost()){a.setHost(c),a.setClient("parentId",c.getId());var d=this.refMapJson[a.getId()];d?d.setParentId(c.getId()):console.warn("2D对象参数与jsonObject不匹配, id2d="+a.getId(),a,this.refMapJson)}}else a.setHost(null),a.setClient("parentId",null),this.refMapJson[a.getId()].setParentId(null)}var e=this.getChildren(a);e.forEach(function(c){c.getHost&&c.setHost&&a!=c.getHost()&&(c.setHost(a),c.setClient("parentId",a.getId()),b.refMapJson[c.getId()].setParentId(a.getId()))})},getParent:function(a){var b=this._getParent(a);return b},_getParent:function(a){for(var b=a.getCenterLocation(),c=a.getLayerId(),d=this.box2d.getLayerBox(),e=d.size(),g=e-1;g>=0;g--){var h=d.getDataAt(g);if(!(h.getId()>=c)&&h.getId()!=this.wallChildLayer&&h.getId()!=this.innerWallChildLayer&&h.getId()!=this.innerWallLayer)for(var i=0;i<this.box2d.size();i++){var j=this.box2d.getDataAt(i);if(j.getLayerId()==h.getId()){var k=j.getLocation(),l=j.getSize(),m={x:k.x,y:k.y,width:l.width,height:l.height};if(f.isPointInRect(b,m))return j}}}},getChildren:function(a){var b=this._getChildren(a);return b},_getChildren:function(a){for(var b=[],c=a.getLocation(),d=a.getSize(),e={x:c.x,y:c.y,width:d.width,height:d.height},g=a.getLayerId(),h=this.box2d.getLayerBox(),i=h.size(),j=0;i>j;j++){var k=h.getDataAt(j);if(!(k.getId()<=g)&&k.getId()!=this.wallChildLayer&&k.getId()!=this.innerWallChildLayer&&k.getId()!=this.innerWallLayer)for(var l=0;l<this.box2d.size();l++){var m=this.box2d.getDataAt(l),n=m.getCenterLocation();if(m.getLayerId()==k.getId()&&f.isPointInRect(n,e)){var o=this.getParent(m);o==a&&b.push(m)}}}return b}}),d.edit.Edit2D=function(a,b){this.jsonBox=a||new d.edit.JsonBox,this.editor=b,this._init(),this.loadDataFlag=!1},d.edit.Edit2D.CONTAINER_CLASS="edit2d-container",twaver.Util.ext(d.edit.Edit2D,Object,{_init:function(){this.accordionPane=new c.AccordionPane;this.network2d=new d.edit.GridNetwork,this.network2d.setMinZoom(.1),this.network2d.setMaxZoom(5),this.box=this.network2d.getElementBox();var a=this.sheet=new twaver.controls.PropertySheet(this.box);f.initPropertySheet(a),this.network2dView=this._initNetwork2d(),this.clientBidQuickFinder=new twaver.QuickFinder(this.box,"bid","client");var b=new d.edit.BoxBridge(this.box,this.jsonBox);b.bind(),this.setDragAndDropImage(this.network2d.getView()),this.network2d.addInteractionListener(function(a){"doubleClickElement"==a.kind&&this.doubleClickRackHandler&&this.doubleClickRackHandler(a.element,this.box)},this),this.box.getSelectionModel().addSelectionChangeListener(this.handleSelectionChange,this),this.editor.propertySheetBox.append(this.sheet.getView()),this.editor.accordionPaneBox.append(this.accordionPane.getView()),this.editor.networkBox.append(this.network2dView)},createNodesByJson:function(a){f.createJsonObject(this.jsonBox,a),this.box.getSelectionModel().clearSelection()},zoomOverview:function(){this.network2d.zoomOverview()},setDragAndDropImage:function(a){var b=this;k.setDropTarget(a,{dropEffect:"copyMove",ondrop:function(a,c){b.dragNode&&(b.dragNode=null,b.currentItem=null)},ondragover:function(a){if(a.preventDefault(),b.dragNode){b.dragNode.isAddInBox||(b.dragNode.isAddInBox=!0,b.dragNode.setStyle("whole.alpha",.7),b.box.add(b.dragNode));var c=b.network2d.getLogicalPoint(a),d=c.x,e=c.y;e-=b.dragNode.getSize().height/2,b.dragNode.setLocation(d,e)}},ondragleave:function(a){b.dragNode&&(b.dragNode.isAddInBox&&b.box.remove(b.dragNode),b.dragNode=null,b.currentItem=null)}})},_initNetwork2d:function(){var a=new d.edit.interaction.RoomListener(this.network2d,this.propertySheetPane,this.jsonBox);a.initRoomSettings();var b=this.ruler=new d.edit.Ruler(this.network2d);return b.getView().setAttribute("class","room-ruler"),b.setShowGuides(!1),b.setShowRuler(!0),this.network2d.getLabel=function(a){return f.isEditModel(a)?a.getClient("label"):void 0},b.getView()},layoutGUI:function(){this.ruler.invalidate()},getJsonBox:function(){return this.jsonBox},getRegionJson:function(a){var b=null,c=this;return b=this.jsonBox.toJson(function(b){return c._isRegion(b,a)})},_isRegion:function(a,b){var c=a.type;return b&&b!=a.getId()?!1:"area-rect"==c||"area-round"==c||"area-polygon"==c?!0:!1},loadData:function(){var b=this.network2d.getElementBox();this.loadDataFlag||(this.loadDataFlag=!0,d.edit.model.model2d.loadData(b,JSON.parse(a.localStorage.getItem("scene"))||[]));var c=[];b.forEach(function(a){"area"==a.getClient("type")&&c.push(a)}),c.forEach(function(a){b.remove(a)}),d.edit.model.model2d.loadData(b,JSON.parse(a.localStorage.getItem("region"))||[])},getObject2dById:function(a){return a?this.clientBidQuickFinder.findFirst(a):null},doubleClickRackHandler:function(a,b){},handleSelectionChange:function(){if(this.editor.isPropertySheetVisible()){
var a=this,b=a.sheet.getPropertyBox();b.clear();var c=this.box.getSelectionModel();if(1!=c.size())b.clear(),this.editor.propertySheetBox.hide();else{this.editor.propertySheetBox.show();var d=c.getLastData(),e=make.Default.getId(d);e=f.getSceneEditorModel2dId(e),f.addProperties(b,make.Default.getModelDefaultParameterProperties(e)),a.editor.resetPropertySheetBoxSize(this.sheet)}}}}),d.edit.Edit3D=function(a,b){this.jsonBox=a||new d.edit.JsonBox,this.editor=b,this._init(),this.isZoom=!1},twaver.Util.ext(d.edit.Edit3D,Object,{_init:function(){this.network3dView=this._initNetwork3d(),this.jsonBox.addDataBoxChangeListener(this._handleJsonBoxChange,this),this.editor.contentPane3d.append(this.network3dView)},_initNetwork3d:function(){var a=this.network3d=new mono.Network3D,b=new mono.PerspectiveCamera(30,1.5,50,2e4);a.setCamera(b),b.p(638,2571,2763),a.setClearColor("#000000"),a.setClearAlpha(0),a.setBackgroundImage("./images/bg_network.jpg");var c=a.getDefaultInteraction();c.yLowerLimitAngle=Math.PI/180*2,c.yUpLimitAngle=Math.PI/2,c.maxDistance=1e4,c.minDistance=50,c.zoomSpeed=3,c.panSpeed=.2,a.setInteractions([c]);var d=this.box=a.getDataBox(),e=new mono.PointLight(16777215,.1);e.setPosition(8e3,8e3,8e3),d.add(e),d.add(new mono.AmbientLight("white")),a.getRootView().setAttribute("class","network3d-view");var g=function(a,b){var c=b.getCamera(),d=b.getDefaultInteraction(),e=f.findFirstObjectByMouse(b,a);if(e){var g=e.element,h=e.point,i=c.getTarget();if(g.getClient("animation"))if("rack_door"==g.getClient("type")&&g.getClient("animated")){var j=g.getParent().getChildren().toList(function(a){return g!=a&&a.getClient("animated")}),k=j.size(),l=0;k>0?j.forEach(function(a){make.Default.playAnimation(a,a.getClient("animation"),function(){l++,l==k&&make.Default.playAnimation(g,g.getClient("animation"))})}):make.Default.playAnimation(g,g.getClient("animation"))}else make.Default.playAnimation(g,g.getClient("animation"));else f.animateCamera(c,d,i,h);if(g.getClient("dbl.func")){var m=g.getClient("dbl.func");m(g,b,e,a)}else if(g.getParent()&&g.getParent().getClient("dbl.func")){var m=g.getParent().getClient("dbl.func");m&&m(g.getParent(),b,e,a)}}else{var i=c.getTarget(),h=new mono.Vec3(0,0,0);f.animateCamera(c,d,i,h)}};return a.getRootView().addEventListener("dblclick",function(b){g(b,a)}),a.getRootView()},refreshNetwork3d:function(){var a=this,b=this.network3d.getDataBox();b.clear();var c=this.jsonBox.getDatas().toArray();make.Default.load(c,function(c){if(c&&c.length>0){for(var d=0;d<c.length;d++){var e=c[d];b.addByDescendant(e),e.setClient("dbl.func",function(c,d){a.doubleClickHandler(c,b)})}setTimeout(function(){var a=new mono.Cube(.1,.1,.1);b.add(a),setTimeout(function(){b.remove(a)},500)},500)}});this.isZoom||this.zoomToOverview()},findByBID:function(a){return this.bidQuickFinder||(this.bidQuickFinder=new mono.QuickFinder(this.network3d.getDataBox(),"bid","client")),this.bidQuickFinder.findFirst(a)},doubleClickHandler:function(a,b){},zoomToOverview:function(){this.isZoom=!0,this.network3d.zoomEstimateOverview(45);var a=this.network3d.getNetworkBoundingBox();console.log(a);var b=this.network3d.getCamera(),c=b.p(),d=b.t();b.setPosition(c.x+2500,c.y+3500,c.z+3500),setTimeout(function(){mono.Utils.playCameraAnimation(b,new mono.Vec3(c.x+500,c.y+500,c.z+500),d,500)},1e3)},getView:function(){return this.network3dView},getJsonBox:function(){return this.jsonBox},_handleJsonBoxChange:function(a){kind=a.kind,"clear"==kind&&this.network3d.getDataBox().clear()}}),d.edit.EditDrop=function(){this.dropFunctionMap={},this.registerDropFunction("model",this.onModelDrop),this.registerDropFunction("default",this.onDefaultDrop)},mono.extend(d.edit.EditDrop,Object,{registerDropFunction:function(a,b){this.dropFunctionMap[a]=b},onDrop:function(a,b){"string"==typeof b&&(b=JSON.parse(b));var c=b.dragType,d=this.dropFunctionMap[c];d?d(a,b):this.onDefaultDrop(a,b)},onModelDrop:function(a,b){var c=b.model;c&&console.log("load model : "+c)},onDefaultDrop:function(a,b){console.log("onDefaultDrop"),a.setInteractions([new d.edit.interaction.RoomDragInteraction(a)])}}),d.edit.ImportDxf=function(a){this.scale=a||1},twaver.Util.ext(d.edit.ImportDxf,Object,{loadDxf:function(a){var b=this;if(!(a instanceof File))return b._loadDxfFile(a);if(a.name.match(/\.dxf$/i)){var c=new FileReader;c.onload=function(a){b.loadDxf(a.target.result)},c.readAsText(a)}else alert("Only dxf file is supported")},_loadDxfFile:function(a){function b(a){var d=make.Default.getType(a.attrib.layer);if(d&&"wall"==d)a instanceof dxf.LineData?(e=a.y1<e?a.y1:e,e=a.y2<e?a.y2:e,f=a.y1>f?a.y1:f,f=a.y2>f?a.y2:f,g=a.x1<g?a.x1:g,g=a.x2<g?a.x2:g,h=a.x1>h?a.x1:h,h=a.x2>h?a.x2:h):a instanceof dxf.PolylineData?a.points.forEach(function(a){e=a.y<e?a.y:e,f=a.y>f?a.y:f,g=a.x<g?a.x:g,h=a.x>h?a.x:h}):a instanceof dxf.InsertData;else if(a instanceof dxf.InsertData&&"road"===a.name){var i=c.getEntitiesFromInsertData(a);i.forEach(function(a){b(a)})}}var c=this;c.data=a;var d=c.parser=new dxf.Dxf;d.parse(a);var e=Number.POSITIVE_INFINITY,f=Number.NEGATIVE_INFINITY,g=Number.POSITIVE_INFINITY,h=Number.NEGATIVE_INFINITY,i=[];d.sections.entities.forEach(function(a){b(a)}),c.minY=e,c.maxY=f,c.minX=g,c.maxX=h;var j=[],i=c.walls=[];return d.sections.entities.forEach(function(a){var b=a.attrib.layer,d=make.Default.getType(b);("wall"==d||"innerWall"==d)&&c.createJsonArray(a,j,b)}),d.sections.entities.forEach(function(a){var b=a.attrib.layer,d=make.Default.getType(b);"door"==d?c.createBlockJson(a,b,i,10):"window"==d&&c.createBlockJson(a,b,i,50)}),d.sections.entities.forEach(function(a){var b=a.attrib.layer,d=make.Default.getType(b);"wall"==d||"innerWall"==d||"door"==d||"window"==d||c.createJsonArray(a,j,b)}),j},createBlockJson:function(a,b,c,d){var e,f=this,g=this.translatePoint({x:a.x1,y:a.y1}),h=this.translatePoint({x:a.x2,y:a.y2});if(c.some(function(a){return index=f.getPointIndex(a,g),index<0&&(index=f.getPointIndex(a,h)),index>=0&&(e=a),null!=e}),!(null==e||index<0)){var i={x:(g.x+h.x)/2,y:(g.y+h.y)/2},j=this.getPointOffset(e,i,index),k=Math.atan((g.y-h.y)/(g.x-h.x));e.children=e.children||[];var l=Math.sqrt((g.x-h.x)*(g.x-h.x)+(g.y-h.y)*(g.y-h.y)),m={id:b,position:[i.x,d,i.y],rotation:[0,k,0],width:l,client:{edgeIndex:index,offset:j}};e.children.push(m)}},createJsonArray:function(a,b,c){var d=(a.attrib.layer.split("#"),make.Default.getType(c)),e=this.getEntityPoints(a,1===a.flags),f={};if("wall"==d||"innerWall"==d||"floor"==d)f={id:c,data:e},"wall"==d&&e[0].toString()==e[e.length-1].toString()&&(e=e.slice(0,e.length-1),f.data=e,f.closed=!0,f.showFloor=!0);else{var g=this.getRectOfPoints(e);if(!g)return null;var h=g.max.x-g.min.x,i=g.max.y-g.min.y,j=g.center(),k=0;a instanceof dxf.InsertData&&(k=a.angle),f={id:c,width:h,depth:i,rotation:[0,k,0],position:[j.x,"floor-top",j.y]}}b.push(f),("wall"==d||"innerWall"==d)&&this.walls.push(f)},translatePoint:function(a){var b=0,c=0,d=0,e=0,f=d-b,g=e-c,h=0,i=0,j=this.scale;return{x:(a.x-b-f/2)*j+h,y:(-a.y+e-g/2)*j+i}},getFixedNumber:function(a){return parseFloat(a.toFixed(0))},getEntitiesPoints:function(a,b,c){var d=[],e=this;return a.forEach(function(a){var f=e.getEntityPoints(a,1===a.flags,b,c),g=d.length;g>=4&&d[g-2]===f[0]&&d[g-1]===f[1]&&(f.shift(),f.shift()),d.push.apply(d,f)}),d},getRectOfPoints:function(a){if(!a||a.length/2<2)return null;var b=Number.POSITIVE_INFINITY,c=Number.NEGATIVE_INFINITY,d=Number.POSITIVE_INFINITY,e=Number.NEGATIVE_INFINITY,f=0,g=a.length,h=function(a,f){d=Math.min(d,a),e=Math.max(e,a),b=Math.min(b,f),c=Math.max(c,f)};if(g>0&&a[f]instanceof Array)for(;g>f;f++){var i=a[f];2==i.length?h(i[0],i[1]):5==i.length&&"c"==i[0]&&h(i[3],i[4])}else for(;g>f;f+=2)h(a[f],a[f+1]);return{min:{x:d,y:b},max:{x:e,y:c},center:function(){return{x:(this.min.x+this.max.x)/2,y:(this.min.y+this.max.y)/2}}}},getBulgeVertex:function(a,b,c){var d={x:b.x,y:b.y},e={x:c.x,y:c.y},f={},g=(d.x-e.x)*(d.y-e.y)*a;return g>0?f={x:e.x,y:d.y}:0>g&&(f={x:d.x,y:e.y}),f},getEntityPoints:function(a,b,c,d){c=c||0,d=d||0;var e=[],f=this;if(a instanceof dxf.LineData){var g=f.translatePoint({x:a.x1+c,y:a.y1+d});e.push(this.getFixedNumber(g.x),this.getFixedNumber(g.y)),g=f.translatePoint({x:a.x2+c,y:a.y2+d}),e.push(this.getFixedNumber(g.x),this.getFixedNumber(g.y))}else if(a instanceof dxf.PolylineData)for(var h=0;h<a.points.length;h++){var i=a.points[h],g=f.translatePoint({x:i.x+c,y:i.y+d});if(e.push([f.getFixedNumber(g.x),f.getFixedNumber(g.y)]),i.bulge&&.414==Math.abs(i.bulge.toFixed(3))){b=!1;var j=a.points[++h]||a.points[0],k=f.getBulgeVertex(i.bulge.toFixed(3),i,j),l=f.translatePoint({x:j.x+c,y:j.y+d}),m=f.translatePoint({x:k.x+c,y:k.y+d});e.push(["c",f.getFixedNumber(m.x),f.getFixedNumber(m.y),f.getFixedNumber(l.x),f.getFixedNumber(l.y)])}}else if(a instanceof dxf.InsertData){var n=a.name,o=null,p=f.parser.sections.blocks,q=a.ipx+c,r=a.ipy+d;o=p[n],e=f.getEntitiesPoints(o.entities,q,r)}if(b){var s=e.length;(e[s-2]!=e[0]||e[s-1]!=e[1])&&e.push(e[0])}return e},pointArrayToPointObjects:function(a){var b=0,c=a.length,d=[];if(a[0]instanceof Array)for(;c>b;b++)d.push({x:a[b][0],y:a[b][1]});else for(;c>b;b+=2)d.push({x:a[b],y:a[b+1]});return d},isPointOnLine:function(a,b,c,d){0>d&&(d=0);var e=this.getDistanceFromPointToLine(a,b,c);return d>=e&&a.x>=Math.min(b.x,c.x)-d&&a.x<=Math.max(b.x,c.x)+d&&a.y>=Math.min(b.y,c.y)-d&&a.y<=Math.max(b.y,c.y)+d},getDistanceFromPointToLine:function(a,b,c){if(b.x===c.x)return Math.abs(a.x-b.x);var d=(c.y-b.y)/(c.x-b.x),e=(c.x*b.y-b.x*c.y)/(c.x-b.x);return Math.abs(d*a.x-a.y+e)/Math.sqrt(d*d+1)},getPointOffset:function(a,b,c){var d=a.data,e=this.pointArrayToPointObjects(d),f=e[c],g=e[c+1];g=g||e[0];var h=0;return f.x!=g.x?h=(b.x-f.x)/(g.x-f.x):f.y!=g.y&&(h=(b.y-f.y)/(g.y-f.y)),h},getPointIndex:function(a,b){var c=a.data,d=this.pointArrayToPointObjects(c);if(d.length<2)return-1;for(var e=0;e<d.length;e++)if(_twaver.math.getDistance(b,d[e])<=10)return-1;for(var f,g=d[0],e=1;e<d.length;e++){if(f=d[e],this.isPointOnLine(b,g,f,10))return e-1;g=f}return g=d[0],this.isPointOnLine(b,g,f,10)?d.length-1:-1}}),d.edit.JsonBox=function(){this._dataList=new mono.List,this._dataMap={},this._dataBoxChangeDispatcher=new TGL.EventDispatcher,this._dataPropertyChangeDispatcher=new TGL.EventDispatcher},mono.extend(d.edit.JsonBox,Object,{add:function(a){if(a){1===arguments.length&&(index=-1);var b=a.getObjectId();if(this._dataMap.hasOwnProperty(b))throw"Data with ID '"+b+"' already exists";this._dataList.add(a),this._dataMap[b]=a,this._dataBoxChangeDispatcher.fire({kind:"add",data:a,source:this}),a.addPropertyChangeListener(this.handleDataPropertyChange,this)}},contains:function(a){return a?this._dataMap[a.getObjectId()]===a:!1},remove:function(a){if(a){this._dataList.remove(a);var b=a.getObjectId();delete this._dataMap[b],this._dataBoxChangeDispatcher.fire({kind:"remove",data:a,source:this}),a.removePropertyChangeListener(this.handleDataPropertyChange,this)}},getDataById:function(a){return this._dataMap[a]},removeById:function(a){var b=this.getDataById(a);this.remove(b)},getDatas:function(){return this._dataList},clear:function(a){if(this._dataList.size()>0){var b=this._dataList.toList();b.forEach(function(a){a.removePropertyChangeListener(this.handleDataPropertyChange,this)},this),this._dataList.clear(),this._dataMap={},this._dataBoxChangeDispatcher.fire({kind:"clear",datas:b})}},toJson:function(a){var b=[],c=this._dataList;return c.forEach(function(c){var d=c.getId();if("twaver.idc.door"!=d&&"twaver.idc.window"!=d){var e={type:c.type};c.serializeJson(c,e),(!a||a(c))&&b.push(e)}}),b},fromJson:function(a){for(var b=0;b<a.length;b++){var c=a[b];if(null!=c.objectId){if("remove"===c.action){this.removeById(c.objectId);continue}data=this.getDataById(c.objectId),data||(data=new d.edit.data.JsonObject(c.objectId),data._id=c.objectId)}else{data=new d.edit.data.JsonObject}if(data.deserializeJson(data,c),c.children&&c.children.length>0)for(var e=[],f=0;f<c.children.length;f++){var g=c.children[f],h=new d.edit.data.JsonObject(g.objectId);h.deserializeJson(h,g),e.push(h)}data.setChildren(e),this.add(data)}},handleDataPropertyChange:function(a){var b=a.source;this.onDataPropertyChanged(b,a),this._dataPropertyChangeDispatcher.fire(a)},onDataPropertyChanged:function(a,b){},addDataBoxChangeListener:function(a,b,c){this._dataBoxChangeDispatcher.add(a,b,c)},removeDataBoxChangeListener:function(a,b){this._dataBoxChangeDispatcher.remove(a,b)},addDataPropertyChangeListener:function(a,b,c){this._dataPropertyChangeDispatcher.add(a,b,c)},removeDataPropertyChangeListener:function(a,b){this._dataPropertyChangeDispatcher.remove(a,b)}});var q=function(a){q.superClass.constructor.call(this,a),this.pasteOffsetDy=0,this.contentPane3d=$('<div class="edit3d-container"></div>').appendTo(this.parentView),this.jsonBox=new d.edit.JsonBox,this.edit2d=this.edit2d=new d.edit.Edit2D(this.jsonBox,this),this.edit3d=new d.edit.Edit3D(this.jsonBox,this),this.model3dTo2dMapping=i.sceneEditorModel3dTo2dMapping,this.model2dTo3dMapping=i.sceneEditorModel2dTo3dMapping,this.accordionPane=this.edit2d.accordionPane,this.ruler=this.edit2d.ruler,this.network2d=this.edit2d.network2d,this.fileIndex=1,this.init()};q.prototype={init:function(){var a=this;this.edit3d.doubleClickHandler=function(b,c){a.doubleClickHandler3D(b,c)},this.edit2d.doubleClickRackHandler=function(b,c){a.doubleClickHandler2D(b,c)},this.addKeyMoveListener(this.network2d),this.refreshAccordion(),this.adjustNetwork3dBoundingBox(),this.show2D(),this.hide3D()},adjustNetwork3dBoundingBox:function(){mono.Utils.autoAdjustNetworkBounds(this.edit3d.network3d,this.contentPane3d[0],"clientWidth","clientHeight",0,0)},doubleClickHandler3D:function(a,b){},doubleClickHandler2D:function(a,b){},isHost:function(a){return"wall"==a.getClient("type")},loadDxfFile:function(a){var b=this.edit2d,c=new d.edit.ImportDxf(.1),e=c.loadDxf(a);b.createNodesByJson(e),setTimeout(function(){b.zoomOverview()},500)},parentResizeHandle:function(){q.superClass.parentResizeHandle.call(this),this.adjustNetwork3dBoundingBox()},align:function(a){var b=this;if(a){var c=this.edit2d.box.getSelectionModel().getSelection(),d=new twaver.List;c.forEach(function(a){a&&!b.isHost(a)&&d.add(a)}),!d||d.size()<2||make.Default.align(d,a)}},flow:function(a,b){var c=this;if(a){var d=this.edit2d.box.getSelectionModel().getSelection(),e=new twaver.List;d.forEach(function(a){a&&!c.isHost(a)&&e.add(a)}),!e||e.size()<2||make.Default.flow(e,a,b)}},refreshAccordion:function(a){a=a||c.utils.load2dSceneCategory(),this.edit2d.accordionPane.setCategories(a)},show2D:function(){this.contentPane.show(),this.edit2d.layoutGUI()},hide2D:function(){this.contentPane.hide()},show3D:function(){this.contentPane3d.show(),this.adjustNetwork3dBoundingBox(),this.edit3d.refreshNetwork3d()},hide3D:function(){this.contentPane3d.hide(),this.edit3d.box.clear()},zoomOverview:function(){this.edit2d.zoomOverview()},getData:function(a){var b=this,c=this.jsonBox.toJson();if(a){var d=[];return c.forEach(function(a){var c={};make.Default.copyProperties(a,c);var e=c.parentId,f=b.jsonBox.getDataById(e);f&&(f.position=f.position||[0,0,0],c.position=c.position||[0,0,0],c.position[0]-=f.position[0],c.position[2]-=f.position[2]),d.push(c)}),d}return c},setData:function(a,b){var c=this,d={};b&&(a.forEach(function(a){d[a.objectId]=a}),a.forEach(function(a){var b=a.parentId,e=d[b];e||(e=c.jsonBox.getDataById(b)),e&&(e.position=e.position||[0,0,0],a.position=a.position||[0,0,0],a.position[0]+=e.position[0],a.position[2]+=e.position[2])})),this.jsonBox.fromJson(a),setTimeout(function(){c.zoomOverview()},100)},getSelectedData:function(){var a=this.edit2d.box.getSelectionModel().getSelection();if(!a||0==a.size())return[];for(var b=[],c=0;c<a.size();c++){var d=a.get(c),e=this.jsonBox.getDataById(d.getId());b.push(e)}return b},appendData:function(a){return this.jsonBox.add(a)},removeData:function(a){var b=this;return a instanceof Array?a.map(function(a){return b.jsonBox.removeById(a.objectId)}):b.jsonBox.removeById(a.objectId)},clear:function(){this.jsonBox.clear()}},c.SceneEditor=q,c.utils.ext(q,l);var r=d.edit.data.JsonObject=function(a){mono.PropertyChangeDispatcher.call(this),a=a||{},this.objectId=a.objectId||c.id("JsonObject"),this.name=a.name,this.id=a.id,this.radius=a.radius,this.width=a.width,this.height=a.height,this.depth=a.depth,this.position=a.position,this.rotation=a.rotation,this.color=a.color,this.data=a.data,this.client=a.client||{},this.style=a.style||{},this.children=a.children,this.parentId=a.parentId};mono.extend(r,mono.PropertyChangeDispatcher,{getObjectId:function(){return this.objectId},getId:function(){return this.id},setId:function(a){var b=this.id;b!=a&&(this.id=a,this.firePropertyChange("id",b,a))},getColor:function(){return this.color},setColor:function(a){var b=this.color;b!=a&&(this.color=a,this.firePropertyChange("radius",b,a))},getParentId:function(){return this.parentId},setParentId:function(a){var b=this.parentId;b!=a&&(this.parentId=a,this.firePropertyChange("parentId",b,a))},getWidth:function(){return this.width},setWidth:function(a){var b=this.width;b!=a&&(this.width=a,this.firePropertyChange("width",b,a))},getHeight:function(){return this.height},setHeight:function(a){var b=this.height;b!=a&&(this.height=a,this.firePropertyChange("height",b,a))},getDepth:function(){return this.depth},setDepth:function(a){var b=this.depth;b!=a&&(this.depth=a,this.firePropertyChange("depth",b,a))},getName:function(){return this.name},setName:function(a){var b=this.name;b!=a&&(this.name=a,this.firePropertyChange("name",b,a))},isClosed:function(){return this.closed},setClosed:function(a){var b=this.closed;b!=a&&(this.closed=a,this.firePropertyChange("closed",b,a))},isShowFloor:function(){return this.showFloor},setShowFloor:function(a){var b=this.showFloor;b!=a&&(this.showFloor=a,this.firePropertyChange("showFloor",b,a))},getPosition:function(){return this.position},setPosition:function(a){var b=this.position;b!=a&&(this.position=a,this.firePropertyChange("position",b,a))},getRotation:function(){return this.rotation},setRotation:function(a){var b=this.rotation;b!=a&&(this.rotation=a,this.firePropertyChange("rotation",b,a))},getData:function(){return this.data},setData:function(a){var b=this.data;b!=a&&(this.data=a,this.firePropertyChange("data",b,a))},getClient:function(a){return this.client},setClient:function(a){var b=this.client;b!=a&&(this.client=a,this.firePropertyChange("client",b,a))},getStyle:function(a){return this.style},setStyle:function(a){var b=this.style;b!=a&&(this.style=a,this.firePropertyChange("style",b,a))},getChildren:function(a){return this.children},setChildren:function(a){var b=this.children;b!=a&&(this.children=a,this.firePropertyChange("children",b,a))},serializeJson:function(a,b){this.serializePropertyJson("id",a,b),this.serializePropertyJson("objectId",a,b),this.serializePropertyJson("parentId",a,b),this.serializePropertyJson("name",a,b),this.serializePropertyJson("width",a,b),this.serializePropertyJson("height",a,b),this.serializePropertyJson("depth",a,b),a.position&&"0,0,0"!=a.position.toString()&&this.serializePropertyJson("position",a,b),a.rotation&&"0,0,0"!=a.rotation&&this.serializePropertyJson("rotation",a,b),this.serializePropertyJson("data",a,b),this.serializePropertyJson("radius",a,b),this.serializePropertyJson("closed",a,b),this.serializePropertyJson("showFloor",a,b),this.serializePropertyJson("client",a,b),this.serializePropertyJson("style",a,b),this.serializePropertyJson("color",a,b),this.serializeArray("children",a,b)},serializeArray:function(a,b,c){var d=b[a],e=[];if(d&&d instanceof Array&&d.length>0){for(var f=0;f<d.length;f++){var g={};this.serializeJson(d[f],g),e.push(g)}c[a]=e}},serializePropertyJson:function(a,b,c){b[a]&&(c[a]=b[a])},deserializeJson:function(a,b){for(var c in b)this.deserializePropertyJson(a,b[c],c)},deserializePropertyJson:function(a,b,c){a[c]=b},clone:function(){var a=new r;return make.Default.copyProperties(this,a),a}});var s=d.edit.interaction.MyCreateShapeNodeInteraction=function(a,b){d.edit.interaction.MyCreateShapeNodeInteraction.superClass.constructor.call(this,a,b)};twaver.Util.ext(d.edit.interaction.MyCreateShapeNodeInteraction,twaver.vector.interaction.CreateShapeNodeInteraction,{handle_mousedown:function(a){if(0===a.button){var b=this.currentPoint||this.network.getLogicalPoint2(a);if(b){if(2===a.detail){if(this.points){var c=this.shapeNodeFunction(this.points);this.network.addElementByInteraction(c),this.clear();var d=this;setTimeout(function(){d.network.setEditingElement(!1)},0)}}else{if(this.network.isEditingElement()||this.network.setEditingElement(!0),this.points||(this.points=new twaver.List),this.points.size()>0){var e=this.points.get(this.points.size()-1);if(e.x===b.x&&e.y===b.y)return}this.points.add(b)}this.repaint()}}},handle_mousemove:function(a){if(this.points){var b=this.points.get(this.points.size()-1),c=this.network.getLogicalPoint2(a);if(!_twaver.isCtrlDown(a)){var d=c.x-b.x,e=c.y-b.y;Math.abs(d)>=Math.abs(e)?c.y=b.y:c.x=b.x}this.currentPoint=c,this.repaint()}}}),d.edit.interaction.RoomDragInteraction=function(a,b,c){d.edit.interaction.RoomDragInteraction.superClass.constructor.call(this,a),this.propertySheetPane=b,this.jsonBox=c},twaver.Util.ext(d.edit.interaction.RoomDragInteraction,twaver.vector.interaction.BaseInteraction,{setUp:function(){this.addListener("mousedown","mousemove","mouseup","dragover","drop","dblclick")},tearDown:function(){this.removeListener("mousedown","mousemove","mouseup","dragover","drop","dblclick")},handle_dblclick:function(a){},handle_dragover:function(a){a.preventDefault?a.preventDefault():a.returnValue=!1,a.dataTransfer.dropEffect="copy";var b=this.network.getElementAt(a);if(b){if(this.network.lastElement&&this.network.lastElement!==b&&(this.network.lastElement instanceof make.Default.WallShapeNode&&this.network.lastElement.setClient("focusIndex",-1),this.network.lastElement=null),b instanceof make.Default.WallShapeNode){var c=this.network.getLogicalPoint(a),d=b.getPointIndex(c);b.setClient("focusIndex",d),d>=0&&(this.network.lastElement=b)}else this.network.lastElement=null;return!1}},handle_drop:function(a){a.stopPropagation&&a.stopPropagation(),a.preventDefault?a.preventDefault():a.returnValue=!1;var b=a.dataTransfer.getData("Text");if(!b)return!1;var c=JSON.parse(b),e=f.getSceneEditorModel3dId(c.id),g=f.getSceneEditorModel2dId(e),h=this.network.getElementAt(a);if(c.id)if(c.combo){var i=make.Default.load(c.id);f.createJsonObject(this.jsonBox,i,c.id)}else{var j=(make.Default.getOtherParameter(g,"layer")||900,make.Default.getOtherParameter(g,"type"));if("watercable"===j||"wall"===j||"area"===j||"innerWall"===j){var j=function(a){var b=[];a.forEach(function(a){b.push(a.x),b.push(a.y)});var c=make.Default.load({id:g,data:b});return c};this._createShapeNodeInteractions(j)}else if("door"===j||"window"===j){if(h&&h instanceof make.Default.WallShapeNode){var k=this.network.getLogicalPoint(a);h.setClient("focusIndex",-1);var l=h.getPointIndex(k);if(l>=0){var m=h.getPoints(),n=m.get(l),o=m.get(l===m.size()-1?0:l+1),p=o.x-n.x,q=o.y-n.y,r=Math.abs(p)>Math.abs(q)?(k.x-n.x)/p:(k.y-n.y)/q,s=(Math.atan((n.y-o.y)/(n.x-o.x)),new d.edit.data.JsonObject);s.id=e,s.position=[k.x,0,k.y],"window"===make.Default.getOtherParameter(g,"type")?(s.position=[k.x,30,k.y],s.setWidth(120)):"door"===make.Default.getOtherParameter(g,"type")&&(s.position=[k.x,0,k.y],s.setWidth(205)),s.client={edgeIndex:l,offset:r},s.client.id=e;var t=this.jsonBox.getDataById(h.getId());if(this.jsonBox.remove(t),t){var u=t.getChildren()||[];u.push(s),t.setChildren(u)}this.jsonBox.add(t)}}}else{this.network.getSelectionModel().clearSelection();var v=this.network.getLogicalPoint(a),w=[v.x,"floor-top",v.y],x=make.Default.getModelDefaultParameters(f.getSceneEditorModel2dId(e));x&&x.positionY&&(w[1]=x.positionY.value);var y=new d.edit.data.JsonObject;y.id=e,y.position=w,y.client=c,y.client.id=y.id,this.jsonBox.add(y);var z=this.network.getElementBox();this.network.getSelectionModel().appendSelection(z.getDataById(y.getObjectId()))}}return this._setNetworkCreateShapeNodeCursor(),!1},_createShapeNodeInteractions:function(a){this.network.setInteractions([new s(this.network,a),new twaver.vector.interaction.DefaultInteraction(this.network)])},_setNetworkCreateShapeNodeCursor:function(){var a=this;this.network.getInteractions().forEach(function(b){b instanceof twaver.vector.interaction.CreateShapeNodeInteraction&&(a.network.getView().style.cursor="crosshair")})},handle_mousedown:function(a){if(this.mouseDown=!0,this.lastLogicalPoint=this.network.getLogicalPoint(a),this.lastLogicalPoint){var b=this.network.getElementAt(a);if(b instanceof make.Default.WallShapeNode)if(resize=this.network.getElementUI(b).isPointOnBorderLine(this.lastLogicalPoint),null!==resize)this.lastElement=b,this.network.isMovable=function(a){return!1};else{var c=b.getPointIndex(this.network.getLogicalPoint(a));c>=0&&(this.lastIndex=c,this.lastElement=b,this.network.isMovable=function(a){return!1})}b instanceof make.Default.Block&&(this.block=b)}},handle_mousemove:function(a){var b;if(this._setNetworkCreateShapeNodeCursor(),this.mouseDown){var c=this.network.getLogicalPoint(a);if(!c)return this.network.getView().scrollTop+=10,void(this.network.getView().scrollLeft+=10);if(offsetX=this.lastLogicalPoint?c.x-this.lastLogicalPoint.x:0,offsetY=this.lastLogicalPoint?c.y-this.lastLogicalPoint.y:0,this.lastIndex>=0){f.stopPropagation(a);var d=this.lastElement.getPoints(),e=d.get(this.lastIndex),g=d.get(this.lastIndex===d.size()-1?0:this.lastIndex+1);this.network.enableSingleOrientationMove?this.mouseMoved||(this.horizontal=e.x==g.x,this.vertical=!this.horizontal,this.mouseMoved=!0):!this.mouseMoved&&_twaver.isCtrlDown(a)&&(this.horizontal=Math.abs(offsetX)>=Math.abs(offsetY),this.vertical=!this.horizontal,this.mouseMoved=!0),this.vertical||(e.x+=offsetX,g.x+=offsetX),this.horizontal||(e.y+=offsetY,g.y+=offsetY),this.lastElement.firePointsChange(null,this.lastElement.getPoints()),this.lastLogicalPoint=c}if(this.block){var h=this.block.getClient("edgeIndex"),i=this.block.getClient("length"),j=this.block.getClient("offset"),d=this.block.getParent().getPoints(),e=d.get(h),g=d.get(h===d.size()-1?0:h+1),k=g.x-e.x,l=g.y-e.y,m=Math.abs(k)>Math.abs(l),n=m?offsetX:offsetY,o=n;if(this.block.getClient("focusLeft"))m?k>0&&(o=-o):(k>=0&&0>l&&(n=-n),k>=0&&l>0&&(o=-o),0>k&&l>0&&(n=-n,o=-o)),this.block.setClient("length",i-n),this.block.setClient("offset",j-o/Math.abs(m?k:l)/2);else if(this.block.getClient("focusRight"))m?0>k&&(o=-o):(k>=0&&0>l&&(n=-n,o=-o),0>k&&l>0&&(n=-n),0>k&&0>l&&(o=-o)),this.block.setClient("length",i+n),this.block.setClient("offset",j+o/Math.abs(m?k:l)/2);else{var j=Math.abs(k)>Math.abs(l)?(c.x-this.lastLogicalPoint.x)/k:(c.y-this.lastLogicalPoint.y)/l;this.block.setClient("offset",this.block.getClient("offset")+j)}this.lastLogicalPoint=c}null!==b&&this.lastElement&&(0===b?(this.lastElement.setLocation(this.lastElement.getX()+offsetX,this.lastElement.getY()+offsetY),this.lastElement.setSize(this.lastElement.getWidth()-offsetX,this.lastElement.getHeight()-offsetY)):1===b?(this.lastElement.setLocation(this.lastElement.getX(),this.lastElement.getY()+offsetY),this.lastElement.setSize(this.lastElement.getWidth()+offsetX,this.lastElement.getHeight()-offsetY)):2===b?this.lastElement.setSize(this.lastElement.getWidth()+offsetX,this.lastElement.getHeight()+offsetY):3===b&&(this.lastElement.setLocation(this.lastElement.getX()+offsetX,this.lastElement.getY()),this.lastElement.setSize(this.lastElement.getWidth()-offsetX,this.lastElement.getHeight()+offsetY)),this.lastLogicalPoint=c)}else{var p=this.network.getElementAt(a),c=this.network.getLogicalPoint(a);if(this.lastElement&&this.lastElement!==p&&(this.lastElement instanceof make.Default.WallShapeNode&&(this.lastElement.setClient("focusIndex",-1),this.network.getView().style.cursor="default"),this.lastElement instanceof make.Default.Block&&(this.lastElement.setClient("focus",!1),this.lastElement.setClient("focusLeft",!1),this.lastElement.setClient("focusRight",!1),this.network.getView().style.cursor="default"),this.lastElement=null),p instanceof make.Default.WallShapeNode)if(b=this.network.getElementUI(p).isPointOnBorderLine(c),null!==b)this.lastElement=p,this.network.getView().style.cursor="move";else{var h=p.getPointIndex(c);p.setClient("focusIndex",h),h>=0?(this.lastElement=p,_twaver.isAltDown(a)?this.network.getView().style.cursor=this.addPointCursor:this.network.getView().style.cursor="move"):p.isPointOnPoints(c)||(this.network.getView().style.cursor="default")}else p instanceof make.Default.Block?(p.setClient("focus",!0),this.network.getSelectionModel().contains(p)&&_twaver.math.getDistance(c,p.getClient("leftPoint"))<=10?(p.setClient("focusLeft",!0),p.setClient("focusRight",!1),this.network.getView().style.cursor="move"):this.network.getSelectionModel().contains(p)&&_twaver.math.getDistance(c,p.getClient("rightPoint"))<=10?(p.setClient("focusLeft",!1),p.setClient("focusRight",!0),this.network.getView().style.cursor="move"):(p.setClient("focusLeft",!1),p.setClient("focusRight",!1),this.network.getView().style.cursor="default"),this.lastElement=p):this.lastElement=null}},handle_mouseup:function(a){this.mouseDown=!1,this.mouseMoved=!1,this.horizontal=!1,this.vertical=!1,this.lastIndex=-1,this.lastElement=null,this.lastLogicalPoint=null,this.block=null,this.resize=!1,this.network.getView().style.cursor="default",delete this.network.isMovable},getAllElementsAt:function(a){var b={x:a.x-1,y:a.y-1,width:2,height:2},c=this.network.getElementsAtRect(b,!0,null,!1);return c},findFirstFloorAt:function(a){var b=this.getAllElementsAt(a);if(b)for(var c=0;c<b.size();c++)if(b.get(c)instanceof d.edit.data.FloorShapeNode)return b.get(c)}}),d.edit.interaction.RoomEditInteraction=function(a,b){d.edit.interaction.RoomEditInteraction.superClass.constructor.call(this,a)},twaver.Util.ext(d.edit.interaction.RoomEditInteraction,twaver.vector.interaction.EditInteraction,{deletePointCursor:"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABYAAAAWCAYAAADEtGw7AAAACXBIWXMAAAsTAAALEwEAmpwYAAAKTWlDQ1BQaG90b3Nob3AgSUNDIHByb2ZpbGUAAHjanVN3WJP3Fj7f92UPVkLY8LGXbIEAIiOsCMgQWaIQkgBhhBASQMWFiApWFBURnEhVxILVCkidiOKgKLhnQYqIWotVXDjuH9yntX167+3t+9f7vOec5/zOec8PgBESJpHmomoAOVKFPDrYH49PSMTJvYACFUjgBCAQ5svCZwXFAADwA3l4fnSwP/wBr28AAgBw1S4kEsfh/4O6UCZXACCRAOAiEucLAZBSAMguVMgUAMgYALBTs2QKAJQAAGx5fEIiAKoNAOz0ST4FANipk9wXANiiHKkIAI0BAJkoRyQCQLsAYFWBUiwCwMIAoKxAIi4EwK4BgFm2MkcCgL0FAHaOWJAPQGAAgJlCLMwAIDgCAEMeE80DIEwDoDDSv+CpX3CFuEgBAMDLlc2XS9IzFLiV0Bp38vDg4iHiwmyxQmEXKRBmCeQinJebIxNI5wNMzgwAABr50cH+OD+Q5+bk4eZm52zv9MWi/mvwbyI+IfHf/ryMAgQAEE7P79pf5eXWA3DHAbB1v2upWwDaVgBo3/ldM9sJoFoK0Hr5i3k4/EAenqFQyDwdHAoLC+0lYqG9MOOLPv8z4W/gi372/EAe/tt68ABxmkCZrcCjg/1xYW52rlKO58sEQjFu9+cj/seFf/2OKdHiNLFcLBWK8ViJuFAiTcd5uVKRRCHJleIS6X8y8R+W/QmTdw0ArIZPwE62B7XLbMB+7gECiw5Y0nYAQH7zLYwaC5EAEGc0Mnn3AACTv/mPQCsBAM2XpOMAALzoGFyolBdMxggAAESggSqwQQcMwRSswA6cwR28wBcCYQZEQAwkwDwQQgbkgBwKoRiWQRlUwDrYBLWwAxqgEZrhELTBMTgN5+ASXIHrcBcGYBiewhi8hgkEQcgIE2EhOogRYo7YIs4IF5mOBCJhSDSSgKQg6YgUUSLFyHKkAqlCapFdSCPyLXIUOY1cQPqQ28ggMor8irxHMZSBslED1AJ1QLmoHxqKxqBz0XQ0D12AlqJr0Rq0Hj2AtqKn0UvodXQAfYqOY4DRMQ5mjNlhXIyHRWCJWBomxxZj5Vg1Vo81Yx1YN3YVG8CeYe8IJAKLgBPsCF6EEMJsgpCQR1hMWEOoJewjtBK6CFcJg4Qxwicik6hPtCV6EvnEeGI6sZBYRqwm7iEeIZ4lXicOE1+TSCQOyZLkTgohJZAySQtJa0jbSC2kU6Q+0hBpnEwm65Btyd7kCLKArCCXkbeQD5BPkvvJw+S3FDrFiOJMCaIkUqSUEko1ZT/lBKWfMkKZoKpRzame1AiqiDqfWkltoHZQL1OHqRM0dZolzZsWQ8ukLaPV0JppZ2n3aC/pdLoJ3YMeRZfQl9Jr6Afp5+mD9HcMDYYNg8dIYigZaxl7GacYtxkvmUymBdOXmchUMNcyG5lnmA+Yb1VYKvYqfBWRyhKVOpVWlX6V56pUVXNVP9V5qgtUq1UPq15WfaZGVbNQ46kJ1Bar1akdVbupNq7OUndSj1DPUV+jvl/9gvpjDbKGhUaghkijVGO3xhmNIRbGMmXxWELWclYD6yxrmE1iW7L57Ex2Bfsbdi97TFNDc6pmrGaRZp3mcc0BDsax4PA52ZxKziHODc57LQMtPy2x1mqtZq1+rTfaetq+2mLtcu0W7eva73VwnUCdLJ31Om0693UJuja6UbqFutt1z+o+02PreekJ9cr1Dund0Uf1bfSj9Rfq79bv0R83MDQINpAZbDE4Y/DMkGPoa5hpuNHwhOGoEctoupHEaKPRSaMnuCbuh2fjNXgXPmasbxxirDTeZdxrPGFiaTLbpMSkxeS+Kc2Ua5pmutG003TMzMgs3KzYrMnsjjnVnGueYb7ZvNv8jYWlRZzFSos2i8eW2pZ8ywWWTZb3rJhWPlZ5VvVW16xJ1lzrLOtt1ldsUBtXmwybOpvLtqitm63Edptt3xTiFI8p0in1U27aMez87ArsmuwG7Tn2YfYl9m32zx3MHBId1jt0O3xydHXMdmxwvOuk4TTDqcSpw+lXZxtnoXOd8zUXpkuQyxKXdpcXU22niqdun3rLleUa7rrStdP1o5u7m9yt2W3U3cw9xX2r+00umxvJXcM970H08PdY4nHM452nm6fC85DnL152Xlle+70eT7OcJp7WMG3I28Rb4L3Le2A6Pj1l+s7pAz7GPgKfep+Hvqa+It89viN+1n6Zfgf8nvs7+sv9j/i/4XnyFvFOBWABwQHlAb2BGoGzA2sDHwSZBKUHNQWNBbsGLww+FUIMCQ1ZH3KTb8AX8hv5YzPcZyya0RXKCJ0VWhv6MMwmTB7WEY6GzwjfEH5vpvlM6cy2CIjgR2yIuB9pGZkX+X0UKSoyqi7qUbRTdHF09yzWrORZ+2e9jvGPqYy5O9tqtnJ2Z6xqbFJsY+ybuIC4qriBeIf4RfGXEnQTJAntieTE2MQ9ieNzAudsmjOc5JpUlnRjruXcorkX5unOy553PFk1WZB8OIWYEpeyP+WDIEJQLxhP5aduTR0T8oSbhU9FvqKNolGxt7hKPJLmnVaV9jjdO31D+miGT0Z1xjMJT1IreZEZkrkj801WRNberM/ZcdktOZSclJyjUg1plrQr1zC3KLdPZisrkw3keeZtyhuTh8r35CP5c/PbFWyFTNGjtFKuUA4WTC+oK3hbGFt4uEi9SFrUM99m/ur5IwuCFny9kLBQuLCz2Lh4WfHgIr9FuxYji1MXdy4xXVK6ZHhp8NJ9y2jLspb9UOJYUlXyannc8o5Sg9KlpUMrglc0lamUycturvRauWMVYZVkVe9ql9VbVn8qF5VfrHCsqK74sEa45uJXTl/VfPV5bdra3kq3yu3rSOuk626s91m/r0q9akHV0IbwDa0b8Y3lG19tSt50oXpq9Y7NtM3KzQM1YTXtW8y2rNvyoTaj9nqdf13LVv2tq7e+2Sba1r/dd3vzDoMdFTve75TsvLUreFdrvUV99W7S7oLdjxpiG7q/5n7duEd3T8Wej3ulewf2Re/ranRvbNyvv7+yCW1SNo0eSDpw5ZuAb9qb7Zp3tXBaKg7CQeXBJ9+mfHvjUOihzsPcw83fmX+39QjrSHkr0jq/dawto22gPaG97+iMo50dXh1Hvrf/fu8x42N1xzWPV56gnSg98fnkgpPjp2Snnp1OPz3Umdx590z8mWtdUV29Z0PPnj8XdO5Mt1/3yfPe549d8Lxw9CL3Ytslt0utPa49R35w/eFIr1tv62X3y+1XPK509E3rO9Hv03/6asDVc9f41y5dn3m978bsG7duJt0cuCW69fh29u0XdwruTNxdeo94r/y+2v3qB/oP6n+0/rFlwG3g+GDAYM/DWQ/vDgmHnv6U/9OH4dJHzEfVI0YjjY+dHx8bDRq98mTOk+GnsqcTz8p+Vv9563Or59/94vtLz1j82PAL+YvPv655qfNy76uprzrHI8cfvM55PfGm/K3O233vuO+638e9H5ko/ED+UPPR+mPHp9BP9z7nfP78L/eE8/sl0p8zAAAAIGNIUk0AAHolAACAgwAA+f8AAIDpAAB1MAAA6mAAADqYAAAXb5JfxUYAAAGYSURBVHja1JS/SwJhGMc/r16ieXENRSBJQijo0OIS/gE1BK4tzorQVHNTU3OB2ByNDW21tTidtClY0A+nFvHojsCyt+UNTvMujSL6LHccz/fD8/Lc+4hsNssQa8A6kAPS6lsTqAHnwIW72DRNRqG53hPAFlAqpyw9M9tjKfoKwL2jrTa6odVKyygCVeAQuMMHzSXdKyatQj7uEAnKgaKM0SNj9NhYdPSzdnTn6NpYAHb95AH13ComrcJmwv4kdRMJSjYTNsWkVVCnw0+8BpTycYdxUbUllfUUr5dTlu7X6ajOyylLV0P2FOcysz0mRWVyfuL0x/QnQWXSXw3vxwkAzXtHmzioMk0/ca3RDU0sVpman/i80jLs574YW/rcF1Rahq2uuKf4AqietaNji1VtdXhvuAnGYjGAVr0TngsH5cryzAtTAe9OTx90jq6NY2DfNM3uV+IucFXvhPsntzMrUU2GEDCtSV7eBDdPU1w+Rtg25+16J3ygpL5LSHxnbXqtygGxlPJX/mPtOyEhhPyzjn/1Sv8v8fsAeL2I1faEYBkAAAAASUVORK5CYII'),auto",
setUp:function(){d.edit.interaction.RoomEditInteraction.superClass.setUp.apply(this,arguments)},tearDown:function(){d.edit.interaction.RoomEditInteraction.superClass.setUp.apply(this,arguments)},handle_mouseup:function(a){if(this.isStart){var b=_twaver.clone(this._endLogical);if(this.resizingRect)if(this.lazyMode)if(this.network.isResizeAnimate()){var c=this,d=new twaver.animate.AnimateBounds(this.node,this.resizingRect,function(){c.network.fireInteractionEvent({kind:"lazyResizeEnd",event:a,element:c.node,resizeDirection:c.resizeDirection})});twaver.animate.AnimateManager.start(d)}else this.node.setLocation(this.resizingRect.x,this.resizingRect.y),this.node.setSize(this.resizingRect.width,this.resizingRect.height),this.network.fireInteractionEvent({kind:"lazyResizeEnd",event:a,element:this.node,resizeDirection:this.resizeDirection});else this.node.setLocation(this.resizingRect.x,this.resizingRect.y),this.node.setSize(this.resizingRect.width,this.resizingRect.height),this.network.fireInteractionEvent({kind:"liveResizeEnd",event:a,element:this.node,resizeDirection:this.resizeDirection});else if(this.shapeNode&&this.pointIndex>=0&&b){var e=this.shapeNode.getPoints().get(this.pointIndex);this.horizontal&&(b.y=e.y),this.vertical&&(b.x=e.x),this.shapeNode.setPoint(this.pointIndex,b),this.network.fireInteractionEvent({kind:"liveMovePointEnd",event:a,element:this.shapeNode,pointIndex:this.pointIndex})}else if(this.shapeLink&&this.pointIndex>=0&&b){var e=this.shapeLink.getPoints().get(this.pointIndex);this.horizontal&&(b.y=e.y),this.vertical&&(b.x=e.x),this.shapeLink.setPoint(this.pointIndex,b),this.network.fireInteractionEvent({kind:"liveMovePointEnd",event:a,element:this.shapeLink,pointIndex:this.pointIndex})}else this.linkUI&&b&&(this.linkUI.setControlPoint(b),this.network.fireInteractionEvent({kind:"liveMovePointEnd",event:a,element:this.linkUI._element}))}this._handle_mouseup(a),this.clear()},_isEditingShapeNode:function(a,b){if(this.node instanceof twaver.ShapeNode){this.shapeNode=this.node;for(var c=this.shapeNode.getPoints(),d=this.network.getEditPointSize(),e=0,f=c.size();f>e;e++){var g=c.get(e);if(this._contains(a,g,d))return _twaver.isAltDown(b)?this._setCursor(this.deletePointCursor):this._setCrossCursor(),this.pointIndex=e,!0}if(!this.shapeNode.getPointIndex)return!1;if(null!=this.shapeNode.getPointIndex(a)&&this.shapeNode.getPointIndex(a)>=0)return!0}return this.pointIndex=-1,!1},_resetShapeNodePoints:function(a){if(this.lastPoint){if(!_twaver.isCtrlDown(event)){var b=a.x-this.lastPoint.x,c=a.y-this.lastPoint.y;Math.abs(b)>=Math.abs(c)?a.y=this.lastPoint.y:a.x=this.lastPoint.x}}else this.lastPoint=a;d.edit.interaction.RoomEditInteraction.superClass._resetShapeNodePoints.call(this,a)},handle_mousemove:function(a){if(this.network.isValidEvent(a)){if(this.isStartRotate&&this.node)return this._handleRotateElement(a,this.node),void(this.network.isShowRotateScale()&&this.repaint());if(this.isStart){if(this.shapeNode&&this.pointIndex>=0){this._handleMovingShapeNodePoint(a);return}if(this.shapeLink&&this.pointIndex>=0)return void this._handleMovingShapeLinkPoint(a);if(this.node&&this.resizeDirection)return void this._handleResizing(a);if(this.linkUI)return void this._handleMovingLinkControlPoint(a);var b=this.network.getLogicalPoint2(a);if(this.node&&this.node instanceof twaver.ShapeNode&&this.node.getPointIndex(b)&&this.node.getPointIndex(b)>=0)return void(this.network._dragToPan=!1)}else{this.lastPoint=null;var c=this.network.getElementAt(a);if(this.network.isSelectingElement()||this.network.isMovingElement()||0===this.network.getSelectionModel().size())return void this.clear();var d=this.network.getElementUI(c);if(!d||!d.getEditAttachment())return void this.clear();var b=this.network.getLogicalPoint2(a);if(c instanceof twaver.ShapeNode&&(b=this.network.getLogicalPoint(a)),c instanceof twaver.Node){if(this.node=c,this.node instanceof make.Default.Block)return this.network._dragToPan=!1,void(this.isStart=!0);if(this._isEditingShapeNode(b,a)||this._isResizingNode(b))return void this.network.setEditingElement(!0);if(this._isRotatingElement(b))return this.network.setRotatingElement(!0),void this.network.setEditingElement(!0)}else if(c instanceof twaver.ShapeLink){if(this.shapeLink=c,this._isEditingShapeLink(b))return void this.network.setEditingElement(!0)}else if(d instanceof twaver.network.LinkUI&&twaver.Link.isOrthogonalLink(d._element)){this.linkUI=d;var e=this.linkUI.getControlPoint();return void(e&&this._contains(b,e)&&(this._setCrossCursor(),this.network.setEditingElement(!0)))}this.clear()}}},handle_mousedown:function(a){if(0===a.button)if(!_twaver.isAltDown(a)||this.network.isEditingElement()){if(this.network.isEditingElement()&&!this.isStart&&!this.isStartRotate)if(this.node&&this.resizeDirection)this.isStart=!0,this._handle_mousedown(a),this.network.fireInteractionEvent({kind:this.lazyMode?"lazyResizeStart":"liveResizeStart",event:a,element:this.node,resizeDirection:this.resizeDirection});else if(this.shapeNode&&this.pointIndex>=0){var b=this.shapeNode.getPoints()._as.length;_twaver.isAltDown(a)?2==b?confirm("You will delete the entire wall, Sure to Delete")&&(this.shapeNode.removeAt(0),this.shapeNode.removeAt(1),this.network.fireInteractionEvent({kind:"removePoint",event:a,element:this.shapeNode})):confirm("Sure to Delete")&&(3==b&&this.shapeNode.setClient("shapenode.closed",!1),this.shapeNode.removeAt(this.pointIndex),this.network.fireInteractionEvent({kind:"removePoint",event:a,element:this.shapeNode})):(this.isStart=!0,this._handle_mousedown(a),this.network.fireInteractionEvent({kind:"liveMovePointStart",event:a,element:this.shapeNode,pointIndex:this.pointIndex}))}else this.shapeLink&&this.pointIndex>=0?_twaver.isAltDown(a)?(this.shapeLink.removeAt(this.pointIndex),this.network.fireInteractionEvent({kind:"removePoint",event:a,element:this.shapeLink})):(this.isStart=!0,this._handle_mousedown(a),this.network.fireInteractionEvent({kind:"liveMovePointStart",event:a,element:this.shapeLink,pointIndex:this.pointIndex})):this.linkUI?(this.isStart=!0,this._handle_mousedown(a),this.network.fireInteractionEvent({kind:"liveMovePointStart",event:a,element:this.linkUI._element})):this.shapeNode?this.isStart=!0:this.node&&(this.node.getClient("className")&&"mono.Billboard"==this.node.getClient("className")||(this.isStartRotate=!0,this._handle_mousedown(a)))}else{var c=this.network.getElementAt(a),d=this.network.getLogicalPoint(a);if(c instanceof twaver.ShapeNode){var e=this.getPointIndex(c.getPoints(),d,!0);e>0&&(this._handle_mousedown(a),this.pointIndex=e,this.shapeNode=c,c.addPoint(d,e),this._setCrossCursor(),this.network.setEditingElement(!0),this.isStart=!0,this.network.fireInteractionEvent({kind:"addPoint",event:a,element:c,pointIndex:e}),this.network.fireInteractionEvent({kind:"liveMovePointStart",event:a,element:c,pointIndex:e}))}if(c instanceof twaver.ShapeLink){var f=new twaver.List(c.getPoints()),g=this.network.getElementUI(c);f.add(g.getFromPoint(),0),f.add(g.getToPoint());var e=this.getPointIndex(f,d)-1;e>0&&(this._handle_mousedown(a),this.pointIndex=e,this.shapeLink=c,c.addPoint(d,e),this._setCrossCursor(),this.network.setEditingElement(!0),this.isStart=!0,this.network.fireInteractionEvent({kind:"addPoint",event:a,element:c,pointIndex:e}),this.network.fireInteractionEvent({kind:"liveMovePointStart",event:a,element:c,pointIndex:e}))}}},clear:function(){d.edit.interaction.RoomEditInteraction.superClass.clear.apply(this,arguments),this.network._dragToPan=!0,this.network.setRotatePointSize(twaver.Defaults.NETWORK_ROTATE_POINT_SIZE)}}),d.edit.interaction.RoomListener=function(a,b,c){d.edit.interaction.RoomListener.superClass.constructor.apply(this,arguments),this.network=a,this.propertySheetPane=b,this.jsonBox=c,this.box2d=this.network.getElementBox(),this.initLayer()},twaver.Util.ext(d.edit.interaction.RoomListener,Object,{initLayer:function(){for(var a=this.box2d.getLayerBox(),b=100;900>=b;b+=100){var c=new twaver.Layer(b);a.add(c)}},initRoomSettings:function(){this.network.enableSingleOrientationMove=!1,this.network.getView().setAttribute("draggable","true"),this.network.setEditPointFillColor("yellow"),this.network.setEditPointOutlineColor("#333333"),this.network.setEditPointOutlineWidth(1),this.network.setEditPointSize(10),this.network.setResizePointSize(0),this.network.setToolTipEnabled(!1),this.network.setKeyboardRemoveEnabled(!1),this.network.setRotatePointFillColor("yellow"),this.interactions2d=[new d.edit.interaction.RoomDragInteraction(this.network,this.propertySheetPane,this.jsonBox),new d.edit.interaction.RoomEditInteraction(this.network),new twaver.vector.interaction.DefaultInteraction(this.network)],this.network.setInteractions(this.interactions2d),this.installNetwork2dFunctions(this.network),this.installNetwork2dListeners(this.network)},installNetwork2dFunctions:function(a){a.isRotatable=function(a){return f.isEditModel(a)},a.isEditable=function(){return!0},a.setMovableFunction(function(a){return f.isMoveModel(a)}),a.setEditableFunction(function(a){return f.isEditModel(a)})},installNetwork2dListeners:function(a){var b=this;a.getElementBox().addDataBoxChangeListener(this.handleDataBoxChange,this),a.addElementByInteraction=function(a){twaver.vector.Network.prototype.addElementByInteraction.call(this,a),setTimeout(function(){b.network.setInteractions(b.interactions2d)},100)}},handleDataBoxChange:function(a){var b=this,c=a.kind,d=a.data;if("add"===c){var e=f.getSceneEditorModel2dId(d.getClient("id"));d.setLayerId(make.Default.getOtherParameter(e,"layer")||900);var g=make.Default.getOtherParameter(e,"type");g&&g.indexOf("wall")>=0&&setTimeout(function(){b.network.zoomOverview()},100)}}})}(window);